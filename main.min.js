var main=function(exports){"use strict";const SERVER_ROOT="https://localhost:8080",FSG_NAMESPACE="https://rintaroutw.github.io/fsg",FSG_RUNTIME_NAMESPACE="FSG_RUNTIME",SVGJS_SCRIPT_NAMESPACE="SVGJS_SCRIPT",SVGJS_SCRIPT_URL=String.raw`<script href="${SERVER_ROOT}/lib/svg.min.js" />`,RUNTIME_SCRIPT_URL=String.raw`<script href="${SERVER_ROOT}/runtime.min.js" />`,RUNTIME_DEFAULT_STYLE=String.raw`<style>
svg {
  user-select: none;
  -webkit-user-select: none;
}

svg .fsg-board {
  fill: #151c23;
}

svg .fsg-ui-select-box {
  stroke-width: 0.5;
  fill: none;
}

svg .menu {
  font: 0.9em Roboto, Helvetica, Sans-Serif, Times, serif, monospace;
}

svg .menu_title {
  fill: #aaa;
  font-family: Georgia, 'Times New Roman', Times, serif;
}

svg .menu_item {
  font-weight: 300;
  fill: #888;
}

svg .menu_item:hover {
  fill: #fff;
  cursor: pointer;
}

svg *[fsg_hidden] {
  visibility: hidden;
}

svg *[fsg_shape]:hover {
  stroke: #fff;
}

svg *[fsg-stroke-type="dashed"] {
  stroke-dasharray: 2.5 2.5;
  stroke-width: 1.2;
}

svg *[fsg-stroke-type="dashed2"] {
  stroke-dasharray: 6 3;
  stroke-width: 1.2;
}

svg *[fsg-stroke-type="dashed3"] {
  stroke-dasharray: 5 5;
  stroke-width: 1.2;
}

svg *[fsg-stroke-type="dashed4"] {
  stroke-dasharray: 3 2 8;
  stroke-width: 1.2;
}

svg .axis-x, svg .axis-y {
  stroke: #555; 
  stroke-width: 1.2;
}

svg .vector-marker-start, svg .vector-marker-end {
  fill: #999;
}

svg .point {
  fill: #2f2f2f;
  stroke: #ff0;
}

svg .pin-point {
  fill: #777777aa;
  stroke: #ff0;
}

svg .mid-point, svg .intersect-point {
  fill: #777777aa;
  stroke: #8a8a8aaa;
}

svg .point:hover, svg .pin-point:hover {
  cursor: grab;
}

svg .mid-point:hover, svg .intersect-point:hover {
  cursor: pointer;
}

svg g, svg div, svg foreignObject, svg span {
  position: relative;
}

svg span.base {
  position: relative !important;
}

svg .latex-container {
  width: max-content;
  height: max-content;
  position: fixed; /* important for Safari */
}

svg .latex,
svg .label {
  color: #999;
  fill: #999;
  font-family: 'KaTeX_Math', 'Times New Roman', Times, serif;
}

svg .length-marker,
svg .angle-marker {
  fill: none
}
</style>`,RUNTIME_STYLE_LINK=String.raw`<link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" href="${SERVER_ROOT}/style/runtime.css"/>`,KATEX_STYLE_LINK=String.raw`<link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" href="${SERVER_ROOT}/lib/katex/katex.min.css"/>`,SNAP_GRID_INTERVAL=5,DEFAULT_WINDOW_WIDTH=883,DEFAULT_WINDOW_HEIGHT=910,FSG_HOVER_ATTR="fsg_hover",FSG_DRAGGING_ATTR="fsg_dragging",FSG_SELECTED_ATTR="fsg_selected",FSG_INSPECTING_ATTR="fsg_inspecting",FSG_SHAPE_ATTR="fsg_shape",CLASS_FSG_BOARD="fsg-board",CLASS_FSG_UI_SELECT_BOX="fsg-ui-select-box",DEFAULT_BOARD_RADIUS=8,FSG_HIDDEN_ATTR="fsg_hidden",NO_ATTR="fsg-no",REFS_ATTR="fsg-refs",OF_ATTR="fsg-of",TEXT_ATTR="fsg-text",VECTOR_START_MARKER_RADIUS=3,VECTOR_END_MARKER_ARROW_WIDTH=6,VECTOR_END_MARKER_ARROW_LENGTH=10,DEFAULT_LENGTH_MARKER_DISTANCE=20,DEFAULT_LENGTH_MARKER_WIDTH=7,DEFAULT_ANGLE_RADIUS=15,POINT_RADIUS=6,DEFAULT_TEXT=String.raw`\LaTeX`,DEFAULT_LABEL_OFFSET_X=5,DEFAULT_LABEL_OFFSET_Y=5,DEFAULT_FILL_COLOR="#ff0f6328",DEFAULT_STROKE_COLOR="#888888aa",DEFAULT_TEXT_COLOR="#aaaaaaff",DEFAULT_TRANSPARENT_COLOR="#ffffff00",FSG_STROKE_TYPE_ATTR="fsg-stroke-type",wait=e=>new Promise((t=>setTimeout(t,e)));function snapTo(e){return{x:e.x-=e.x%SNAP_GRID_INTERVAL,y:e.y-=e.y%SNAP_GRID_INTERVAL}}function loadCSS(e){const t=document.createElement("link");t.href=e,t.type="text/css",t.rel="stylesheet",(document.head||document.documentElement).appendChild(t)}function loadScript(e,t=!1,n){let o=document.createElement("script");o.type="text/javascript",o.src=e,o.async=t,n&&(o.onload=n()),(document.head||document.documentElement).appendChild(o)}function isRightButton(e){return 2==e.button&&(e.preventDefault(),e.stopPropagation(),!0)}function init_module_extension(){SVG.extend(SVG.Element,{anime:function(...e){return this.animate(...e).during((()=>this.fire("update")))},unhide:function(){return this.attr(FSG_HIDDEN_ATTR,null)},hide:function(){return this.attr(FSG_HIDDEN_ATTR,!0)}}),SVG.extend(SVG.Runner,{update:function(){return this.during((()=>this.element().fire("update")))}})}const tolerance_error=1e-4;function distanceOfPoints(e,t){return Math.sqrt((t.cx()-e.cx())**2+(t.cy()-e.cy())**2)}function distanceOfCoords(e,t){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}function lengthOfVector(e){return Math.sqrt(e.x**2+e.y**2)}function inside(e,t){return t&&t.x>=e.x-tolerance_error&&t.x<=e.x+e.width+tolerance_error&&t.y>=e.y-tolerance_error&&t.y<=e.y+e.height+tolerance_error}function pointOnScreen(e){const t=e.element,n=t.cx(),o=t.cy(),r=t.transform();return{x:n*r.a+o*r.c+r.e,y:n*r.b+o*r.d+r.f}}function clipping(e,t,n){const o={x:n.x-t.x,y:n.y-t.y},{x:r,y:i,width:s,height:a}=e;let c=[],l={x:1,y:0},d=intersect(t,o,n={x:r,y:i},l);return inside(e,d)&&c.push(d),l={x:0,y:1},d&&d.x==r||(d=intersect(t,o,n,l),inside(e,d)&&c.push(d)),d=intersect(t,o,n={x:r+s,y:i+a},l),inside(e,d)&&c.push(d),l={x:1,y:0},d&&d.y==i+s||(d=intersect(t,o,n,l),inside(e,d)&&c.push(d)),c}function intersect(e,t,n,o){let r=t.x*o.y-o.x*t.y;if(0==r||isNaN(r))return null;let i=((n.x-e.x)*o.y-(n.y-e.y)*o.x)/r;return{x:e.x+i*t.x,y:e.y+i*t.y}}function projectPointOnLine(e,t,n){const o=e.x-t.x,r=e.y-t.y,i=o*n.x+r*n.y;return{x:t.x+n.x*i,y:t.y+n.y*i}}function intersectLineAndCircle(e,t,n,o){const r=projectPointOnLine(n,e,t),i=(n.x-r.x)**2+(n.y-r.y)**2;if(i>o**2)return null;if(i==o**2)return[r];const s=Math.sqrt(o**2-i);return[{x:r.x+t.x*s,y:r.y+t.y*s},{x:r.x-t.x*s,y:r.y-t.y*s}]}function twoCirclesIntersection(e,t){var n,o,r,i,s,a,c=Math.sqrt((e.a-t.a)**2+(e.b-t.b)**2);if(e.r+t.r>=c&&c>=Math.abs(e.r-t.r)){var l=c+e.r+t.r,d=c+e.r-t.r,u=c-e.r+t.r,p=-c+e.r+t.r,f=Math.sqrt(l*d*u*p)/4;if(r=(n=(e.a+t.a)/2+(t.a-e.a)*(e.r*e.r-t.r*t.r)/(2*c*c))+(o=2*(e.b-t.b)*f/(c*c)),i=n-o,s=(n=(e.b+t.b)/2+(t.b-e.b)*(e.r*e.r-t.r*t.r)/(2*c*c))-(o=2*(e.a-t.a)*f/(c*c)),a=n+o,Math.abs((r-e.a)*(r-e.a)+(s-e.b)*(s-e.b)-e.r*e.r)>1e-7){var h=s;s=a,a=h}return[{x:r,y:s},{x:i,y:a}]}return null}function init_component_system(e){e.fsg.component={};const t=e.find(`[${NO_ATTR}]`);let n=0;t.forEach((e=>{const t=Number(e.attr(NO_ATTR));t>n&&(n=t)})),e.fsg.component.max_no=n,e.fsg.component.all=[]}function deinit_component_system(e){e.fsg.component.all.forEach((e=>{e.remove()})),e.fsg.component.all=[]}function componentByNo(e,t){return e.fsg.component.all.find((e=>e.no==Number(t)))}function labelOf(e,t){return e.find(".label").toArray().find((e=>t==Number(e.attr(OF_ATTR))))}class Component{constructor({draw:e,element:t,refs:n}){this.draw=e,this.element=t,t.component=this;let o=t.attr(NO_ATTR);if(void 0===o&&(e.fsg.component.max_no++,o=e.fsg.component.max_no,t.attr(NO_ATTR,o)),this.no=Number(o),!t.hasClass("latex")){const e=t.attr(TEXT_ATTR);e&&this.addLabel(e)}n&&(t.attr(REFS_ATTR,n.join(",")),this.refComponents=n.map((t=>componentByNo(e,t))),this.refComponents.forEach((e=>{e.element.on("update",this.update.bind(this)),e.element.on("remove",this.remove.bind(this))}))),e.fsg.component.all.push(this)}update(){}remove(){this.refComponents?.forEach((e=>{e.element.off("remove",this.remove),e.element.off("update",this.update)})),this.removeLabel(),this.element.fire("remove").remove(),this.draw.fsg.component.all=this.draw.fsg.component.all.filter((e=>e!==this))}center(){return{x:this.element.cx(),y:this.element.cy()}}forward(){this.element.forward(),this.element.next()?.hasClass("cover")&&this.element.forward()}backward(){this.element.prev()?.hasClass("cover")&&this.element.backward(),this.element.backward()}back(){this.draw.findOne("."+CLASS_FSG_UI_SELECT_BOX).after(this.element)}front(){this.element.front()}undo(){this.remove()}getAttributes(){return["id","class","cx","cy",TEXT_ATTR]}getAttribute(e){return e==TEXT_ATTR?this.getText():this.element.attr(e)}setAttribute(e,t){this.getAttributes().includes(e)&&(this.element.attr(e,t),e!=TEXT_ATTR||this.setText(t))}setText(e){e&&0!=e.length?this.label?this.label.text(e):this.addLabel(e):this.removeLabel()}getText(){return this.label?this.label.text():""}addLabel(e){const t=this.draw,n=this.element;let o=labelOf(t,this.no);if(!o){const r=this.center(),i={x:r.x+DEFAULT_LABEL_OFFSET_X,y:-r.y+DEFAULT_LABEL_OFFSET_Y};o=t.text(e).attr("class","label").attr("offset_x",DEFAULT_LABEL_OFFSET_X).attr("offset_y",DEFAULT_LABEL_OFFSET_Y).attr(OF_ATTR,n.attr(NO_ATTR)).flip("y").move(i.x,i.y);const s=n.attr(FSG_HIDDEN_ATTR)??null;o.attr(FSG_HIDDEN_ATTR,s).attr("opacity",n.attr("opacity")),t.add(o)}o.on("mousedown",(e=>{isRightButton(e)||(t.dragStart={x:o.cx(),y:o.cy()},o.lastEvent="mousedown",o.fire("dragstart",{dragTarget:o}),e.stopPropagation())})).on("mouseup",(e=>{isRightButton(e)||(o.lastEvent="mouseup",o.fire("dragend"))})).on("mousemove",(()=>{o.lastEvent="mousemove"})).on("dragstart",(()=>{o.orgValue={x:o.cx(),y:o.cy()},t.dragTarget=o})).on("dragend",(()=>{t.dragTarget=null;const e=this.center(),n={dx:o.x()-e.x,dy:o.y()+e.y};o.attr("offset_x",n.dx).attr("offset_y",n.dy)})),n.on("update",(()=>{const e=o.attr("offset_x"),t=o.attr("offset_y"),r=this.center(),i={x:r.x+e,y:-r.y+t};o.move(i.x,i.y);const s=n.attr(FSG_HIDDEN_ATTR)??null;o.attr(FSG_HIDDEN_ATTR,s).attr("opacity",n.attr("opacity"))}));const r=new MutationObserver((e=>{e.forEach((e=>{if(e.attributeName==TEXT_ATTR){let e=n.node.getAttribute(TEXT_ATTR);e||(e="");const t=o.attr("offset_x"),r=o.attr("offset_y"),i=this.center(),s={x:i.x+t,y:-i.y+r};o.text(e).move(s.x,s.y)}}))}));r.observe(n.node,{attributes:!0}),this.observer=r,this.label=o}removeLabel(){this.label&&(this.observer.disconnect(),this.observer=null,this.label.remove(),this.label=null)}}class SelectableComponent extends Component{constructor({draw:e,element:t,refs:n,override:o}){super({draw:e,element:t,refs:n}),o||(t.on("mouseenter",(()=>{e.dragTarget||e.selectStart||t.attr(FSG_HOVER_ATTR,!0)})).on("mouseleave",(()=>{t.attr(FSG_HOVER_ATTR,null)})),t.on("mousedown",(n=>{isRightButton(n)||window.FSG_BUILDER&&e.endAppendingPoint(n)||(t.lastEvent="mousedown",n.stopPropagation())})).on("mouseup",(e=>{isRightButton(e)||("mousedown"==t.lastEvent&&this.toggleSelected(),t.lastEvent="mouseup")}))),selectComponent(this.draw,this)}remove(){unselectComponent(this.draw,this),super.remove()}toggleSelected(){this.isSelected()?unselectComponent(this.draw,this):selectComponent(this.draw,this)}isSelected(){return this.element.attr(FSG_SELECTED_ATTR)}select(){this.element.attr(FSG_SELECTED_ATTR,!0)}unselect(){this.element.attr(FSG_SELECTED_ATTR,null).attr(FSG_HOVER_ATTR,null)}}function findBottom(e,t){let n=t[0];return t.forEach((t=>{const o=e.index(t);-1!=o&&o<e.index(n)&&(n=t)})),n}function putBehindPoints(e,t,n,o){if(!n)return;const r=findBottom(e,t);e.index(r)>0&&(n.insertBefore(r),o.insertBefore(n))}class Shape extends SelectableComponent{constructor({draw:e,element:t,refs:n,cover:o,points:r}){super({draw:e,element:t,refs:n}),this.points=r,this.cover=o,o?.attr(OF_ATTR,this.no).attr("fill",DEFAULT_TRANSPARENT_COLOR),o?.on("mousedown",(t=>{isRightButton(t)||window.FSG_BUILDER&&e.endAppendingPoint(t)||(this.toggleSelected(),t.stopPropagation())})).on("mouseenter",(()=>{e.dragTarget||e.selectStart||t.attr(FSG_HOVER_ATTR,!0)})).on("mouseleave",(()=>{t.attr(FSG_HOVER_ATTR,null)}))}remove(){this.cover?.remove(),super.remove()}getAttributes(){return["id","class","cx","cy","stroke",FSG_STROKE_TYPE_ATTR,TEXT_ATTR]}forward(){this.cover?.forward(),this.element.forward(),this.cover?.next()?.hasClass("cover")&&(this.cover?.forward(),this.element.forward())}backward(){this.element.prev()?.hasClass("cover")&&(this.element.backward(),this.cover?.backward()),this.element.backward(),this.cover?.backward()}back(){const e=this.draw.findOne("."+CLASS_FSG_UI_SELECT_BOX);this.cover&&e.after(this.cover),e.after(this.element)}front(){this.element.front(),this.cover?.front()}}let _enabled=!1,_hexInput,_colorPicker,_colorBeforeChange;function enableColorPicker(){_enabled=!0,attachColorPicker(SVG("#field_fill").node)}function init_module_color_picker(){_colorPicker=new iro.ColorPicker("#colorPicker",{width:120,color:"#8a0238ff",borderWidth:1,borderColor:"#fff",layoutDirection:"horizontal",layout:[{component:iro.ui.Wheel},{component:iro.ui.Slider,options:{sliderType:"value"}},{component:iro.ui.Slider,options:{sliderType:"alpha"}}]}),SVG("#field_fill").node.value=DEFAULT_FILL_COLOR,SVG("#field_stroke").node.value=DEFAULT_STROKE_COLOR,_enabled=!1}function toHex8String(e){if(/^#[a-f|0-9]{3}$/i.test(e)){return("#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+"ff").toLowerCase()}return/^#[a-f|0-9]{6}$/i.test(e)?e.toLowerCase()+"ff":/^#[a-f|0-9]{8}$/i.test(e)?e.toLowerCase():/^none$/i.test(e)?DEFAULT_TRANSPARENT_COLOR:null}function onInputChange(){const e=toHex8String(_hexInput.value);e&&(_enabled=!1,_colorPicker.color.hex8String=e,_enabled=!0)}function onColorChange(e){_enabled&&(_hexInput.value=e.hex8String,SVG(_hexInput).fire("input"))}function attachColorPicker(e){_colorPicker&&_enabled&&(_hexInput=e??_hexInput,_hexInput.addEventListener("change",onInputChange),"field_fill"==_hexInput.getAttribute("id")?document.querySelector("#colorIndicator").style.right="180px":document.querySelector("#colorIndicator").style.right="260px",onInputChange(),_colorPicker.on("color:change",onColorChange),_colorPicker.on("input:start",(()=>{_colorBeforeChange=_hexInput.value;const e={field:_hexInput.getAttribute("id")};document.dispatchEvent(new CustomEvent("colorpicker:change-start",{detail:e}))})),_colorPicker.on("input:end",(()=>{const e={field:_hexInput.getAttribute("id"),oldValue:_colorBeforeChange,newValue:_hexInput.value};document.dispatchEvent(new CustomEvent("colorpicker:change-end",{detail:e}))})))}function currentFillColor(){return SVG("#field_fill").node.value}function currentStrokeColor(){return SVG("#field_stroke").node.value}function useCurrentColors(e){if(window.FSG_BUILDER){const t=currentFillColor(),n=currentStrokeColor();e.attr("fill",t),e.attr("stroke",n)}}function setStrokeColor(e){if(window.FSG_BUILDER){const t=currentStrokeColor();e.attr("stroke",t)}}function coverForLineElement(e,t){if(window.FSG_BUILDER){const n={x:t.attr("x1"),y:t.attr("y1")},o={x:t.attr("x2"),y:t.attr("y2")},r=e.line(n.x,n.y,o.x,o.y).attr("class","cover");return t.after(r),r}return null}class LineShape extends Shape{constructor({draw:e,element:t,refs:n,cover:o,points:r}){super({draw:e,element:t,refs:n,cover:o,points:r}),this.isAppending=null}startPoint(){const e=this.points[0];let t={x:e.cx(),y:e.cy()};return e.component&&(t=pointOnScreen(e.component)),t}updateDirection(){const[e,t]=this.points,n=pointOnScreen({element:e}),o=pointOnScreen({element:t}),r=o.x-n.x,i=o.y-n.y,s=Math.sqrt(r**2+i**2);0!=s&&(this._direction={x:r/s,y:i/s})}direction(){return this._direction||this.updateDirection(),this._direction}endAppendMode(){this.isAppending&&(this.isAppending.remove(),this.isAppending=null)}toggleAppendMode(e){if(this.isAppending)this.endAppendMode();else{const t=this.no;this.isAppending=e.addAppendingPinPoint({draw:e,componentRef:t})}}getAttributes(){return["id","class","cx","cy","stroke",FSG_STROKE_TYPE_ATTR,TEXT_ATTR]}}class Line extends LineShape{constructor({draw:e,element:t,refs:n,points:o,cover:r}){super({draw:e,element:t,refs:n,cover:r,points:o})}update(){const[e,t]=this.points,n=this.draw.bbox(),o=pointOnScreen(e.component),r=pointOnScreen(t.component),[i,s]=clipping(n,o,r);i&&s&&(this.element.plot(i.x,i.y,s.x,s.y),this.cover?.plot(i.x,i.y,s.x,s.y),this.updateDirection(),this.element.fire("update"))}}function addLine({draw:e,refs:t,element:n,cover:o,no:r}){const i=t.map((t=>componentByNo(e,t).element));if(!n){const t=e.bbox(),[r,s]=i,a={x:r.cx(),y:r.cy()},c={x:s.cx(),y:s.cy()},[l,d]=clipping(t,a,c);setStrokeColor(n=e.line(l.x,l.y,d.x,d.y).attr("class","line").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.line(l.x,l.y,d.x,d.y).attr("class","cover")}return o=o??coverForLineElement(e,n),putBehindPoints(e,i,o,n),r&&n.attr(NO_ATTR,r),new Line({draw:e,element:n,refs:t,points:i,cover:o})}function getClipped(e,t,n){const o=e.bbox(),[r,i]=clipping(o,{x:t.x,y:t.y},{x:n.x,y:n.y});if(!r||!i)return;const s=n.x-t.x,a=n.y-t.y,c=r.x-t.x,l=r.y-t.y;let d=r;return 0!=s?c*s<0&&(d=i):l*a<0&&(d=i),d}class Ray extends LineShape{constructor({draw:e,element:t,refs:n,points:o,cover:r}){super({draw:e,element:t,refs:n,cover:r,points:o})}update(){const[e,t]=this.points,n=pointOnScreen(e.component),o=pointOnScreen(t.component),r=getClipped(this.draw,n,o);r&&(this.element.plot(n.x,n.y,r.x,r.y),this.cover?.plot(n.x,n.y,r.x,r.y),this.updateDirection(),this.element.fire("update"))}}function addRay({draw:e,element:t,refs:n,cover:o,no:r}){const i=n.map((t=>componentByNo(e,t).element));if(!t){const[n,r]=i,s={x:n.cx(),y:n.cy()},a={x:r.cx(),y:r.cy()},c=getClipped(e,s,a);setStrokeColor(t=e.line(s.x,s.y,c.x,c.y).attr("class","ray").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.line(s.x,s.y,c.x,c.y).attr("class","cover")}return o=o??coverForLineElement(e,t),putBehindPoints(e,i,o,t),r&&t.attr(NO_ATTR,r),new Ray({draw:e,element:t,refs:n,cover:o,points:i})}function clippedParallelLine(e,t,n){const o=n.component.center(),r=t.component.direction(),i=n,s={x:o.x+20*r.x,y:o.y+20*r.y};return clipping(e.bbox(),{x:i.cx(),y:i.cy()},{x:s.x,y:s.y})}class ParallelLine extends LineShape{constructor({draw:e,element:t,refs:n,cover:o,no:r}){let i=n.map((t=>componentByNo(e,t).element));if(!t){const[n,r]=i,[s,a]=clippedParallelLine(e,n,r);setStrokeColor(t=e.line(s.x,s.y,a.x,a.y).attr("class","parallel-line").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.line(s.x,s.y,a.x,a.y).attr("class","cover")}o=o??coverForLineElement(e,t),putBehindPoints(e,i,o,t),r&&t.attr(NO_ATTR,r),super({draw:e,element:t,refs:n,cover:o,points:i})}update(){const[e,t]=this.points,[n,o]=clippedParallelLine(this.draw,e,t);n&&o&&(this.element.plot(n.x,n.y,o.x,o.y),this.cover?.plot(n.x,n.y,o.x,o.y),this.element.fire("update"))}startPoint(){const e=this.points[1];let t={x:e.cx(),y:e.cy()};return e.component&&(t=pointOnScreen(e.component)),t}direction(){return this.points[0].component.direction()}}function addParallelLine({draw:e,element:t,refs:n,cover:o,no:r}){return new ParallelLine({draw:e,element:t,refs:n,cover:o,no:r})}function clippedPerpLine(e,t,n){const o=pointOnScreen({element:n}),r=t.component.direction(),i=pointOnScreen({element:n}),s={x:o.x,y:o.y},a={x:i.x-20*r.y,y:i.y+20*r.x};return clipping(e.bbox(),s,a)}class PerpLine extends LineShape{constructor({draw:e,element:t,refs:n,cover:o,no:r}){let i=n.map((t=>componentByNo(e,t).element));if(!t){const[n,r]=i,[s,a]=clippedPerpLine(e,n,r);setStrokeColor(t=e.line(s.x,s.y,a.x,a.y).attr("class","perp-line").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.line(s.x,s.y,a.x,a.y).attr("class","cover")}o=o??coverForLineElement(e,t),putBehindPoints(e,i,o,t),r&&t.attr(NO_ATTR,r),super({draw:e,element:t,refs:n,cover:o,points:i})}update(){const[e,t]=this.points,[n,o]=clippedPerpLine(this.draw,e,t);n&&o&&(this.element.plot(n.x,n.y,o.x,o.y),this.cover?.plot(n.x,n.y,o.x,o.y),this.element.fire("update"))}startPoint(){const e=this.points[1];let t={x:e.cx(),y:e.cy()};return e.component&&(t=pointOnScreen(e.component)),t}direction(){const e=this.points[0].component.direction();return{x:-e.y,y:e.x}}}function addPerpLine({draw:e,element:t,refs:n,cover:o,no:r}){return new PerpLine({draw:e,element:t,refs:n,cover:o,no:r})}class BisectorLine extends LineShape{constructor({draw:e,element:t,refs:n,cover:o,points:r}){super({draw:e,element:t,refs:n,cover:o,points:r})}update(){const[e,t,n]=this.points,o=this.draw.bbox(),r=coordOfBisectorPoint(e,t,n),i={x:t.cx(),y:t.cy()},s={x:r.x,y:r.y},[a,c]=clipping(o,i,s);a&&c&&(this.element.plot(a.x,a.y,c.x,c.y),this.cover?.plot(a.x,a.y,c.x,c.y),this.element.fire("update"))}startPoint(){const e=this.points[1];let t={x:e.cx(),y:e.cy()};return e.component&&(t=pointOnScreen(e.component)),t}direction(){const[e,t,n]=this.points,o=coordOfBisectorPoint(e,t,n),r=this.startPoint(),i=o.x-r.x,s=o.y-r.y,a=Math.sqrt(i**2+s**2);return{x:i/a,y:s/a}}}function coordOfBisectorPoint(e,t,n){const o=e.cx()-t.cx(),r=e.cy()-t.cy(),i=n.cx()-t.cx(),s=n.cy()-t.cy(),a=Math.sqrt(o**2+r**2),c=Math.sqrt(i**2+s**2),l=o/a,d=r/a,u=i/c,p=s/c;return{x:t.cx()+(l+u)/2,y:t.cy()+(d+p)/2}}function addBisectorLine({draw:e,element:t,refs:n,cover:o,no:r}){let i=n.map((t=>componentByNo(e,t).element));if(!t){const[n,r,s]=i,a=e.bbox(),c=coordOfBisectorPoint(n,r,s),l={x:r.cx(),y:r.cy()},d={x:c.x,y:c.y},[u,p]=clipping(a,l,d);setStrokeColor(t=e.line(u.x,u.y,p.x,p.y).attr("class","bisector-line").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.line(u.x,u.y,p.x,p.y).attr("class","cover")}return o=o??coverForLineElement(e,t),putBehindPoints(e,i,o,t),r&&t.attr(NO_ATTR,r),new BisectorLine({draw:e,element:t,refs:n,cover:o,points:i})}class LineSegment extends LineShape{constructor({draw:e,refs:t,element:n,cover:o,points:r}){super({draw:e,element:n,refs:t,cover:o,points:r})}update(){const[e,t]=this.points,n=pointOnScreen(e.component),o=pointOnScreen(t.component);this.element.plot(n.x,n.y,o.x,o.y),this.cover?.plot(n.x,n.y,o.x,o.y),this.updateDirection(),this.element.fire("update")}}function addEdge({draw:e,refs:t,element:n,cover:o,no:r}){const i=t.map((t=>componentByNo(e,t).element));if(!n){const[t,r]=i,s={x:t.cx(),y:t.cy()},a={x:r.cx(),y:r.cy()};setStrokeColor(n=e.line(s.x,s.y,a.x,a.y).attr("class","edge").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.line(s.x,s.y,a.x,a.y).attr("class","cover")}return o=o??coverForLineElement(e,n),putBehindPoints(e,i,o,n),r&&n.attr(NO_ATTR,r),new LineSegment({draw:e,refs:t,element:n,cover:o,points:i})}function addVector({draw:e,refs:t,element:n,cover:o,no:r}){const i=t.map((t=>componentByNo(e,t).element));if(!n){const[t,r]=i,s={x:t.cx(),y:t.cy()},a={x:r.cx(),y:r.cy()};setStrokeColor(n=e.line(s.x,s.y,a.x,a.y).attr("class","vector").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.line(s.x,s.y,a.x,a.y).attr("class","cover")}return o=o??coverForLineElement(e,n),putBehindPoints(e,i,o,n),n.marker("start",e.fsg.marker.vector_start_marker).marker("end",e.fsg.marker.vector_end_marker),r&&n.attr(NO_ATTR,r),new LineSegment({draw:e,refs:t,points:i,element:n,cover:o})}class Axis extends LineSegment{constructor({draw:e,element:t,cover:n,type:o}){super({draw:e,element:t,cover:n}),this._direction="axis-x"==o?{x:1,y:0}:{x:0,y:1}}startPoint(){return{x:this.element.attr("x1"),y:this.element.attr("y1")}}setCoord(e,t){this.element.plot(e.x,e.y,t.x,t.y),this.cover?.plot(e.x,e.y,t.x,t.y),this.element.fire("update")}}function addAxis({draw:e,type:t,element:n,cover:o,no:r}){if(!n){const r=e.parent().viewbox();let i,s;"axis-x"==t?(i={x:-r.width/2,y:0},s={x:r.width/2,y:0}):(i={x:0,y:-r.height/2},s={x:0,y:r.height/2}),n=e.line(i.x,i.y,s.x,s.y).attr("class",t).attr(FSG_SHAPE_ATTR,!0).attr("stroke",DEFAULT_STROKE_COLOR),o=e.line(i.x,i.y,s.x,s.y).attr("class","cover")}return o=o??coverForLineElement(e,n),n.marker("end",e.fsg.marker.vector_end_marker).addClass(t),r&&n.attr(NO_ATTR,r),new Axis({draw:e,element:n,cover:o,type:t})}function coverForCircleElement(e,t){if(window.FSG_BUILDER){const n=t.attr("r"),o=t.attr("cx"),r=t.attr("cy");return e.circle().radius(n).center(o,r).attr("class","cover")}return null}class FillableShape extends Shape{constructor({draw:e,refs:t,element:n,cover:o,points:r}){super({draw:e,refs:t,element:n,cover:o,points:r})}getAttributes(){return["id","class","cx","cy","fill","stroke",FSG_STROKE_TYPE_ATTR,TEXT_ATTR]}}class Circle extends FillableShape{constructor({draw:e,refs:t,radius:n,points:o,element:r,cover:i}){super({draw:e,refs:t,element:r,cover:i,points:o}),this.radius=n}update(){const[e,t]=this.points,n=distanceOfCoords(pointOnScreen({element:e}),pointOnScreen({element:t}));this.radius=n,this.cover?.radius(n).center(e.cx(),e.cy()),this.element.radius(n).center(e.cx(),e.cy()).fire("update")}endAppendMode(){this.isAppending&&(this.isAppending.remove(),this.isAppending=null)}toggleAppendMode(e){if(this.isAppending)this.endAppendMode();else{const t=this.no;this.isAppending=e.addAppendingPinPoint({draw:e,componentRef:t})}}}function addCircle({draw:e,refs:t,element:n,cover:o,no:r}){const i=t.map((t=>componentByNo(e,t).element)),[s,a]=i,c=distanceOfPoints(s,a);return n||(useCurrentColors(n=e.circle().radius(c).center(s.cx(),s.cy()).attr("class","circle").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),o=e.circle().radius(c).center(s.cx(),s.cy()).attr("class","cover")),o=o??coverForCircleElement(e,n),putBehindPoints(e,i,o,n),r&&n.attr(NO_ATTR,r),new Circle({draw:e,refs:t,radius:c,points:i,element:n,cover:o})}class Polygon extends FillableShape{constructor({draw:e,refs:t,points:n,element:o,cover:r}){super({draw:e,refs:t,element:o,cover:r,points:n})}update(){let e=this.points.map((e=>{const t=pointOnScreen(e.component);return[t.x,t.y]}));this.cover?.plot(e),this.element.plot(e).fire("update")}}function addPolygon({draw:e,refs:t,element:n,cover:o,no:r}){const i=t.map((t=>componentByNo(e,t).element)),s=i.map((e=>[e.cx(),e.cy()]));return n||useCurrentColors(n=e.polygon(s).attr("class","polygon").attr(FSG_STROKE_TYPE_ATTR,"dashed").attr(FSG_SHAPE_ATTR,!0)),window.FSG_BUILDER&&(o=e.polygon(s).attr("class","cover")),putBehindPoints(e,i,o,n),r&&n.attr(NO_ATTR,r),new Polygon({draw:e,refs:t,points:i,element:n,cover:o})}function arcPathOf(e,t,n,o=!1){const r=DEFAULT_ANGLE_RADIUS;t={x:t.cx(),y:t.cy()};const i=e.cx()-t.x,s=e.cy()-t.y,a=n.cx()-t.x,c=n.cy()-t.y,l=Math.sqrt(i**2+s**2),d=Math.sqrt(a**2+c**2);if(0==l||0==d)return"";let u=i/l*r,p=s/l*r,f=a/d*r,h=c/d*r;const m=t.x+u,_=t.y+p,g=t.x+f,y=t.y+h;let T=u*h-p*f>=0?0:1,S=1;const x=1e-6;if(o){if(Math.abs(f+p)<x&&Math.abs(h-u)<x)return String.raw`M ${t.x} ${t.y} L ${m} ${_} L ${m+f} ${_+h} L ${g} ${y} Z`}else if(S=1==T?0:1,T=0,Math.abs(f+p)<x&&Math.abs(h-u)<x||Math.abs(u+h)<x&&Math.abs(p-f)<x)return String.raw`M ${t.x} ${t.y} L ${m} ${_} L ${m+f} ${_+h} L ${g} ${y} Z`;return String.raw`M ${m} ${_} A ${r} ${r} 0 ${T} ${S} ${g} ${y} L ${t.x} ${t.y} Z`}class Arc extends FillableShape{constructor({draw:e,refs:t,points:n,element:o,cover:r}){super({draw:e,refs:t,element:o,cover:r,points:n});const i=o.attr("large_arc");this.large_arc=void 0!==i&&"true"==i}update(){const[e,t,n]=this.points,o=arcPathOf(e,t,n,this.large_arc);this.cover?.plot(o),this.element.plot(o).fire("update")}toggleMode(){this.large_arc=!this.large_arc,this.element.attr("large_arc",this.large_arc?"true":"false"),this.points[0].fire("update")}}function addAngle({draw:e,refs:t,element:n,cover:o,no:r}){let i=t.map((t=>componentByNo(e,t).element));if(!n){const[t,o,r]=i,s=arcPathOf(t,o,r,!1);useCurrentColors(n=e.path(s).attr("class","angle").attr(FSG_SHAPE_ATTR,!0))}return window.FSG_BUILDER&&(o=e.path(n.array()).attr("class","cover")),putBehindPoints(e,i,o,n),r&&n.attr(NO_ATTR,r),new Arc({draw:e,refs:t,points:i,element:n,cover:o})}class SelectablePoint extends SelectableComponent{constructor({draw:e,element:t,refs:n,override:o}){o||t.on("mousedown",(e=>{isRightButton(e)||(t.lastEvent="mousedown",e.stopPropagation())})).on("mouseup",(e=>{isRightButton(e)||("mousedown"==t.lastEvent&&this.toggleSelected(),t.lastEvent="mouseup")})),super({draw:e,element:t,refs:n})}getAttributes(){return["id","class","cx","cy",TEXT_ATTR]}}class IntersectPoint extends SelectablePoint{constructor({draw:e,index:t,refs:n,element:o}){super({draw:e,element:o,refs:n}),this.index=t}update(){const e=this.refComponents;if(e[1]instanceof SelectablePoint){const[t,n]=e,o=projectPointOnLine(pointOnScreen(n),t.startPoint(),t.direction());return this.element.center(o.x,o.y),void this.element.fire("update")}if(e[0]instanceof LineShape)if(e[1]instanceof LineShape){const[t,n]=e,o=intersect(t.startPoint(),t.direction(),n.startPoint(),n.direction());if(!o)return;this.element.center(o.x,o.y)}else{const[t,n]=e,o=intersectLineAndCircle(t.startPoint(),t.direction(),n.center(),n.radius);if(!o)return;const r=o[this.index];r&&this.element.center(r.x,r.y)}else if(e[1]instanceof LineShape){const[t,n]=e,o=intersectLineAndCircle(n.startPoint(),n.direction(),t.center(),t.radius);if(!o)return;const r=o[this.index];this.element.center(r.x,r.y)}else{const[t,n]=e,o=twoCirclesIntersection({a:t.center().x,b:t.center().y,r:t.radius},{a:n.center().x,b:n.center().y,r:n.radius});if(!o)return;const r=o[this.index];this.element.center(r.x,r.y)}this.element.fire("update")}}function addIntersectPoint({draw:e,coord:t,index:n,refs:o,element:r,no:i}){return t||(t={x:0,y:0}),r?n=r.attr("index"):r=e.circle(POINT_RADIUS).move(t.x-POINT_RADIUS/2,t.y-POINT_RADIUS/2).attr("class","intersect-point").attr("index",n),i&&r.attr(NO_ATTR,i),new IntersectPoint({draw:e,index:n,refs:o,element:r})}class MidPoint extends SelectablePoint{constructor({draw:e,refs:t,element:n}){super({draw:e,element:n,refs:t})}update(){const e=this.refComponents,[t,n]=e,o=t.center(),r=n.center(),i={x:(o.x+r.x)/2,y:(o.y+r.y)/2};this.element.center(i.x,i.y),this.element.fire("update")}}function addMidPoint({draw:e,refs:t,element:n,no:o}){const r=t.map((t=>componentByNo(e,t).element));if(!n){const[t,o]=r,i={x:t.cx(),y:t.cy()},s={x:o.cx(),y:o.cy()},a={x:(i.x+s.x)/2,y:(i.y+s.y)/2};n=e.circle(POINT_RADIUS).move(a.x-POINT_RADIUS/2,a.y-POINT_RADIUS/2).attr("class","mid-point")}return o&&n.attr(NO_ATTR,o),new MidPoint({draw:e,refs:t,element:n})}class DraggablePoint extends SelectablePoint{constructor({draw:e,element:t,refs:n,override:o}){o||(t.on("mousedown",(n=>{isRightButton(n)||(t.lastEvent="mousedown",e.dragStart={x:t.cx(),y:t.cy()},t.fire("dragstart",{dragTarget:t,shiftKey:n.shiftKey}),n.stopPropagation())})).on("mouseup",(e=>{isRightButton(e)||("mousedown"==t.lastEvent&&this.toggleSelected(),t.lastEvent="mouseup",t.fire("dragend"))})).on("mousemove",(()=>{t.lastEvent="mousemove"})).on("dragstart",(n=>{if(t.component instanceof Point&&n.detail.shiftKey){const n=getSelectedPointElements(e);return n.forEach((e=>{e.attr(FSG_DRAGGING_ATTR,!0),e.orgValue={x:e.cx(),y:e.cy()}})),e.dragPoints=n,void(e.dragTarget=t)}t.attr(FSG_DRAGGING_ATTR,!0),t.orgValue={x:t.cx(),y:t.cy()},e.dragTarget=t})).on("dragend",(()=>{if(window.FSG_BUILDER){const{doAction:n,changeLocation:o}=e.fsg.history,r=[],i=[],s=[];e.dragPoints?e.dragPoints.map((e=>{r.push(e.component.no),i.push(e.orgValue),s.push({x:e.cx(),y:e.cy()}),e.attr(FSG_DRAGGING_ATTR,null)})):(r.push(t.component.no),i.push({x:e.dragStart.x,y:e.dragStart.y}),s.push({x:t.cx(),y:t.cy()})),n(o,{draw:e,refs:r,oldValues:i,newValues:s})}t.attr(FSG_DRAGGING_ATTR,null),e.dragTarget=null,e.dragPoints=null})).on("dragmove",(()=>{t.fire("update",{target:this})})),o=!0),super({draw:e,element:t,refs:n,override:o})}}class Point extends DraggablePoint{constructor({draw:e,element:t}){super({draw:e,element:t})}}function addPoint({draw:e,coord:t,element:n,no:o}){return t||(t={x:0,y:0}),n||setStrokeColor(n=e.circle(POINT_RADIUS).move(t.x-POINT_RADIUS/2,t.y-POINT_RADIUS/2).attr("class","point")),o&&n.attr(NO_ATTR,o),new Point({draw:e,element:n})}class PinPoint extends DraggablePoint{constructor({draw:e,type:t,refs:n,element:o}){super({draw:e,element:o,refs:n,override:!0}),this.type=t,o.on("mousedown",(t=>{isRightButton(t)||(o.lastEvent="mousedown",e.dragStart=e.point(t.clientX,t.clientY),o.fire("dragstart",{dragTarget:o}),t.stopPropagation())})).on("mouseup",(e=>{isRightButton(e)||("mousedown"==o.lastEvent&&this.toggleSelected(),o.lastEvent="mouseup",o.fire("dragend"))})).on("mousemove",(()=>{o.lastEvent="mousemove"})).on("dragstart",(()=>{o.attr(FSG_DRAGGING_ATTR,!0),e.dragTarget=o})).on("dragend",(()=>{if(window.FSG_BUILDER){const{doAction:t,changeLocation:n}=e.fsg.history,r=[o.component.no],i=[{x:e.dragStart.x,y:e.dragStart.y}],s=[{x:o.cx(),y:o.cy()}];t(n,{draw:e,refs:r,oldValues:i,newValues:s})}o.attr(FSG_DRAGGING_ATTR,null),this.calcState(),e.dragTarget=null})).on("dragmove",(()=>{o.fire("update",{target:this})})),this.targetComponent=componentByNo(e,n[0]),this.calcState()}calcState(){const e=this.element;if("line"==this.type){const t=this.targetComponent,n=t.startPoint(),o=t.direction(),r=e.cx()-n.x,i=e.cy()-n.y;this.distance=0!=r?r/o.x:0!=i?i/o.y:0}else{const t=this.targetComponent,n=t.radius;if(0==n)this.unitVector={x:0,y:0};else{const o={x:t.element.cx(),y:t.element.cy()},r={x:e.cx(),y:e.cy()};this.unitVector={x:(r.x-o.x)/n,y:(r.y-o.y)/n}}}}update(){if(this.draw.dragTarget!=this.element){if("line"==this.type){const e=this.targetComponent,t=e.startPoint(),n=e.direction(),o={x:t.x+n.x*this.distance,y:t.y+n.y*this.distance};this.element.center(o.x,o.y)}else{const e=this.targetComponent,t=e.element,n=e.radius;if(0==n)return;const o={x:t.cx(),y:t.cy()},r=this.unitVector,i={x:o.x+r.x*n,y:o.y+r.y*n};this.element.center(i.x,i.y)}this.element.fire("update")}else{if("line"==this.type){const e=this.targetComponent,t=projectPointOnLine(this.draw.mousePosition,e.startPoint(),e.direction());this.element.center(t.x,t.y)}else{const e=this.targetComponent.element,t=this.targetComponent.radius;if(0==t)return;const n={x:e.cx(),y:e.cy()},o={x:this.draw.mousePosition.x-n.x,y:this.draw.mousePosition.y-n.y},r=lengthOfVector(o);if(0==r)return;const i=t/r,s={x:n.x+o.x*i,y:n.y+o.y*i};this.element.center(s.x,s.y)}this.element.fire("update")}}}function addPinPoint({draw:e,coord:t,type:n,refs:o,element:r,no:i}){return r||(r=e.circle(POINT_RADIUS).move(t.x-POINT_RADIUS/2,t.y-POINT_RADIUS/2).attr("class","pin-point")),i&&r.attr(NO_ATTR,i),new PinPoint({draw:e,type:n,refs:o,element:r})}function useCurrentColors$1(e){if(window.FSG_BUILDER){const t=currentStrokeColor();e.attr("style",`color: ${t};`)}}class LaTeX extends SelectableComponent{constructor({draw:e,element:t,refs:n}){if(super({draw:e,element:t,refs:n}),t.removeClass("text").addClass("latex"),n){const o=componentByNo(e,n[0])?.element,r=o.attr(FSG_HIDDEN_ATTR)??null;t.attr(FSG_HIDDEN_ATTR,r).attr("opacity",o.attr("opacity")),this.target=o}this.makeDraggable(e,t)}update(){const e=this.target,t=this.element,n=t.attr("offset_x"),o=t.attr("offset_y"),r={x:e.cx()+n,y:-e.cy()+o};t.move(r.x,r.y);const i=e.attr(FSG_HIDDEN_ATTR)??null;t.attr(FSG_HIDDEN_ATTR,i).attr("opacity",e.attr("opacity")),t.fire("update")}makeDraggable(e,t){const n=this.target;t.on("mousedown",(n=>{isRightButton(n)||(t.lastEvent="mousedown",e.dragStart={x:t.cx(),y:t.cy()},t.fire("dragstart",{dragTarget:t}),n.stopPropagation())})).on("mouseup",(e=>{isRightButton(e)||("mousedown"==t.lastEvent&&this.toggleSelected(),t.lastEvent="mouseup",t.fire("dragend"))})).on("mousemove",(()=>{t.lastEvent="mousemove"})).on("dragstart",(()=>{t.attr(FSG_DRAGGING_ATTR,!0),t.orgValue={x:t.cx(),y:t.cy()},e.dragTarget=t})).on("dragend",(()=>{if(t.attr(FSG_DRAGGING_ATTR,null),e.dragTarget=null,n){const e={dx:t.x()-n.cx(),dy:t.y()+n.cy()};t.attr("offset_x",e.dx).attr("offset_y",e.dy)}})).on("dragmove",(()=>{t.fire("update",{target:this})}))}setText(e){e||(e="");let t=this.element;const n=this.draw,o={x:t.attr("x"),y:-t.attr("y")},r={x:t.attr("offset_x")??0,y:t.attr("offset_y")??0},i=t.attr(OF_ATTR),s=this.getAttribute("stroke");t.clear().remove();const a=genLaTeX(this.draw,e,o);a&&(a.attr("offset_x",r.x).attr("offset_y",r.y).attr(NO_ATTR,this.no),i&&a.attr(OF_ATTR,i),a.component=this,this.element=a,i&&this.watchTarget(n,i),this.makeDraggable(n,a),this.setAttribute("stroke",s),n.add(a))}getText(){return this.element.attr(TEXT_ATTR)}getAttributes(){return["id","class","cx","cy","stroke",TEXT_ATTR]}getAttribute(e){if("stroke"==e){return this.element.node.getAttribute("style")?.replace(/(color| |:|;)/g,"")??DEFAULT_TEXT_COLOR}return super.getAttribute(e)}setAttribute(e,t){"stroke"!=e?super.setAttribute(e,t):this.element.attr("style",`color: ${t};`)}}function foreignTex(e,t){const n=SVG(String.raw`<div xmlns="http://www.w3.org/1999/xhtml" class="latex-container"></div>`);let o;try{let r=katex.renderToString(t,katex_options);r=r.replace(/\&nbsp;/g,"&#160;"),n.node.innerHTML=r,o=e.foreignObject(800,600).add(n);const{width:i,height:s}=n.node.getBoundingClientRect();return o.size(i,s),o}catch(e){return o&&o.remove(),null}}function genLaTeX(e,t,n){const o=foreignTex(e,t).flip("y");return o?(o.attr("class","latex").attr(TEXT_ATTR,t).attr("x",n.x).attr("y",-n.y).attr("style","color: #888"),o):null}function addLaTeX({draw:e,element:t,text:n,unselect:o,refs:r}){if(t){const e=t.attr(OF_ATTR);e&&(r=[e])}else if(r){let o=componentByNo(e,r[0]).center();(t=genLaTeX(e,n=n??DEFAULT_TEXT,o)).attr("offset_x",0).attr("offset_y",0).attr(OF_ATTR,r[0]),useCurrentColors$1(t)}else{const o=e.mousePosition;useCurrentColors$1(t=genLaTeX(e,n=n??DEFAULT_TEXT,o))}const i=new LaTeX({draw:e,element:t,refs:r});return o&&unselectComponent(e,i),i}const katex_options={throwOnError:!1,output:"html",delimiters:[{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0},{left:"\\begin{equation}",right:"\\end{equation}",display:!0}],trust:!0,strict:"ignore",macros:{"\\eqref":"\\href{#1}{}","\\label":"\\href{#1}{}","\\require":"\\href{#1}{}","\\tag":"\\href{#1}{}","\\hfil":"\\space","\\style":"\\href{#1}{}","\\def":"\\gdef","\\cal":"\\mathcal","\\pmatrix":"\\begin{pmatrix}#1\\end{pmatrix}","\\vmatrix":"\\begin{vmatrix}#1\\end{vmatrix}","\\bmatrix":"\\begin{bmatrix}#1\\end{bmatrix}","\\cases":"\\begin{cases}#1\\end{cases}","\\align":"\\begin{aligned}#1\\end{aligned}","\\eqalign":"\\begin{aligned}#1\\end{aligned}","\\array":"\\begin{array}#1\\end{array}","\\gather":"\\begin{gathered}#1\\end{gathered}"}};function arrowedArcPathOf(e,t,n,o=!1){const r=3*DEFAULT_ANGLE_RADIUS;t={x:t.cx(),y:t.cy()};const i={x:e.cx()-t.x,y:e.cy()-t.y},s={x:n.cx()-t.x,y:n.cy()-t.y},a=lengthOfVector(i),c=lengthOfVector(s);if(0==a||0==c)return"";const l=i.x/a*r,d=i.y/a*r,u=s.x/c*r,p=s.y/c*r,f=t.x+l,h=t.y+d,m=t.x+u,_=t.y+p;let g=l*p-d*u>=0?0:1,y=1;return o||(y=1==g?0:1,g=0),String.raw`M ${f} ${h} A ${r} ${r} 0 ${g} ${y} ${m} ${_}`}class ArrowedArc extends Shape{constructor({draw:e,refs:t,points:n,element:o,cover:r}){super({draw:e,refs:t,element:o,cover:r,points:n});const i=o.attr("large_arc");this.large_arc=void 0!==i&&"true"==i}update(){const[e,t,n]=this.points,o=arrowedArcPathOf(e,t,n,this.large_arc);this.cover?.plot(o),this.element.plot(o).fire("update")}center(){const[e,t,n]=this.points,o=4*DEFAULT_ANGLE_RADIUS;let r={x:e.cx()-t.cx(),y:e.cy()-t.cy()};const i=Math.sqrt(r.x**2+r.y**2);r={x:r.x/i*o,y:r.y/i*o};let s={x:n.cx()-t.cx(),y:n.cy()-t.cy()};const a=Math.sqrt(s.x**2+s.y**2);s={x:s.x/a*o,y:s.y/a*o};const c=s.y-r.y,l=-(s.x-r.x),d=Math.sqrt(c**2+l**2);if(0==d)return{x:t.cx()+r.x-DEFAULT_LABEL_OFFSET_X-4,y:t.cy()+r.y+DEFAULT_LABEL_OFFSET_Y+8};const u=r.x*s.y-r.y*s.x,p=o/d;return!this.large_arc&&u<0?{x:t.cx()-c*p-DEFAULT_LABEL_OFFSET_X-4,y:t.cy()-l*p+DEFAULT_LABEL_OFFSET_Y+8}:{x:t.cx()+c*p-DEFAULT_LABEL_OFFSET_X-4,y:t.cy()+l*p+DEFAULT_LABEL_OFFSET_Y+8}}toggleMode(){this.large_arc=!this.large_arc,this.element.attr("large_arc",this.large_arc?"true":"false"),this.points[0].fire("update")}}function addAngleMarker({draw:e,refs:t,element:n,cover:o,no:r}){let i=t.map((t=>componentByNo(e,t).element));if(!n){const[t,o,r]=i,s=arrowedArcPathOf(t,o,r,!1);setStrokeColor(n=e.path(s).attr("class","angle-marker").attr("fill","none").attr(FSG_SHAPE_ATTR,!0))}return window.FSG_BUILDER&&(o=e.path(n.array()).attr("class","cover")),n.marker("end",e.fsg.marker.vector_end_marker),putBehindPoints(e,i,o,n),r&&n.attr(NO_ATTR,r),new ArrowedArc({draw:e,refs:t,points:i,element:n,cover:o})}function normalVec(e,t){const n=t.cx()-e.cx(),o=t.cy()-e.cy(),r=Math.sqrt(n**2+o**2);return 0==r?{x:0,y:0}:{x:-o/r,y:n/r}}function stretchVec(e,t){return{x:e.x*t,y:e.y*t}}function lengthPathOf(e,t,n){const o=normalVec(e,t);if(0==o.x&&0==o.y)return"";const r=DEFAULT_LENGTH_MARKER_WIDTH,i=stretchVec(o,n),s=stretchVec(o,r);e={x:e.cx()+i.x,y:e.cy()+i.y},t={x:t.cx()+i.x,y:t.cy()+i.y};const a=e.x+s.x,c=e.y+s.y,l=e.x-s.x,d=e.y-s.y,u=t.x+s.x,p=t.y+s.y,f=t.x-s.x,h=t.y-s.y;return String.raw`M ${a} ${c} L ${l} ${d}
  M ${u} ${p} L ${f} ${h}
  M ${e.x} ${e.y} L ${t.x} ${t.y}`}class LengthMarker extends Shape{constructor({draw:e,refs:t,points:n,element:o,cover:r}){super({draw:e,refs:t,element:o,cover:r,points:n}),this.mark_on_right=!1}update(){const[e,t]=this.points,n=lengthPathOf(e,t,this.mark_on_right?-DEFAULT_LENGTH_MARKER_DISTANCE:DEFAULT_LENGTH_MARKER_DISTANCE);this.cover?.plot(n),this.element.plot(n).fire("update")}center(){const e=this.mark_on_right?-(DEFAULT_LENGTH_MARKER_DISTANCE+10):DEFAULT_LENGTH_MARKER_DISTANCE+10,[t,n]=this.points,o=normalVec(t,n);return{x:(t.cx()+n.cx())/2+o.x*e-DEFAULT_LABEL_OFFSET_X-4,y:(t.cy()+n.cy())/2+o.y*e+DEFAULT_LABEL_OFFSET_Y+8}}toggleMode(){this.mark_on_right=!this.mark_on_right,this.element.attr("mark_on_right",this.mark_on_right?"true":"false"),this.points[0].fire("update")}}function addLengthMarker({draw:e,refs:t,element:n,cover:o,no:r}){let i=t.map((t=>componentByNo(e,t).element));if(!n){const[t,o]=i,r=lengthPathOf(t,o,DEFAULT_LENGTH_MARKER_DISTANCE);setStrokeColor(n=e.path(r).attr("class","length-marker").attr("fill","none").attr(FSG_SHAPE_ATTR,!0))}return window.FSG_BUILDER&&(o=e.path(n.array()).attr("class","cover")),putBehindPoints(e,i,o,n),r&&n.attr(NO_ATTR,r),new LengthMarker({draw:e,refs:t,points:i,element:n,cover:o})}function execute_user_script(draw){const scripts=draw.parent().defs().find("script");scripts.forEach((script=>{if(script.node.getAttribute("xmlns")==FSG_NAMESPACE)try{eval(script.node.textContent)}catch(e){alert(e.stack)}}))}function findUserScript(e){const t=e.parent().find("script");let n=!1;return t.forEach((e=>{e.node.getAttribute("xmlns")==FSG_NAMESPACE&&(n=e)})),n||(n=SVG("<script><\/script>").attr("xmlns",FSG_NAMESPACE)),n}function findScript(e,t){const n=e.parent().find("script");let o=!1;return n.forEach((e=>{e.node.getAttribute("namespace")==t&&(o=e)})),o}function init_module_script(e){const t=findScript(e,SVGJS_SCRIPT_NAMESPACE),n=findScript(e,FSG_RUNTIME_NAMESPACE);t||e.defs().add(SVG(SVGJS_SCRIPT_URL).attr("namespace",SVGJS_SCRIPT_NAMESPACE)),n||e.defs().add(SVG(RUNTIME_SCRIPT_URL).attr("namespace",FSG_RUNTIME_NAMESPACE));const o=findUserScript(e);o&&e.defs().add(o)}function findAllComponentElements(e){const t=e.find(`[${NO_ATTR}]`);return t.sort(((e,t)=>Number(e.attr(NO_ATTR))-Number(t.attr(NO_ATTR)))),t}function elementByNo(e,t){return e.toArray().find((e=>Number(e.attr(NO_ATTR))==Number(t)))}function reconstruct_components(e){const t=findAllComponentElements(e);t.forEach((n=>{if(n.hasClass("point"))return void addPoint({draw:e,element:n});if(n.hasClass("mid-point")){const t=n.attr(REFS_ATTR);if(!t)return;const o=t.split(",").map((e=>Number(e)));return void addMidPoint({draw:e,refs:o,element:n})}if(n.hasClass("intersect-point")){const t=n.attr(REFS_ATTR);if(!t)return;const o=t.split(",").map((e=>Number(e)));return void addIntersectPoint({draw:e,refs:o,element:n})}if(n.hasClass("pin-point")){const o=n.attr(REFS_ATTR);if(!o)return;const r=[o];let i="line";return elementByNo(t,r[0])instanceof SVG.Circle&&(i="circle"),void addPinPoint({draw:e,type:i,refs:r,element:n})}if(n.hasClass("latex"))return void addLaTeX({draw:e,element:n});if(n.hasClass("axis-x")){return void addAxis({draw:e,type:"axis-x",element:n})}if(n.hasClass("axis-y")){return void addAxis({draw:e,type:"axis-y",element:n})}const o=n.attr(REFS_ATTR);if(!o)return;const r=o.split(",").map((e=>Number(e)));if(n.hasClass("edge"))addEdge({draw:e,refs:r,element:n});else if(n.hasClass("vector"))addVector({draw:e,refs:r,element:n});else if(n.hasClass("line"))addLine({draw:e,refs:r,element:n});else if(n.hasClass("ray"))addRay({draw:e,refs:r,element:n});else if(n.hasClass("polygon"))addPolygon({draw:e,refs:r,element:n});else if(n.hasClass("circle"))addCircle({draw:e,refs:r,element:n});else if(n.hasClass("angle"))addAngle({draw:e,refs:r,element:n});else if(n.hasClass("angle-marker"))addAngleMarker({draw:e,refs:r,element:n});else if(n.hasClass("length-marker"))addLengthMarker({draw:e,refs:r,element:n});else{if(n.hasClass("parallel-line")){let o=r;const[,i]=r,s=elementByNo(t,i);return s.hasClass("parallel-point")&&(o=s.attr(REFS_ATTR).split(",")),void addParallelLine({draw:e,refs:o,element:n})}if(n.hasClass("perp-line")){let o=r;const[,i]=r,s=elementByNo(t,i);return s.hasClass("perp-point")&&(o=s.attr(REFS_ATTR).split(",")),void addPerpLine({draw:e,refs:o,element:n})}n.hasClass("bisector-line")&&addBisectorLine({draw:e,refs:r,element:n})}}))}function patchSVGJS(e){e.find(".latex-container").each((e=>{e.find("svg").each((e=>{e.attr("xmlns:svgjs",null),e.attr("xmlns:svgjs","https://svgjs.com/svgjs")}))}))}function cleanupDirtyElements(e){e.find(".hidden-point, .cover, .parallel-point, .perp-point").each((e=>e.remove()));e.find(".selected, .inspecting, .dragging, .hover, .component, .none, .hidden, .shape").each((e=>{e.removeClass("component").removeClass("selected").removeClass("inspecting").removeClass("dragging").removeClass("hover"),e.hasClass("shape")&&e.removeClass("shape").attr(FSG_SHAPE_ATTR,!0),e.hasClass("none")&&e.removeClass("none").attr("fill","none"),e.hasClass("hidden")&&e.removeClass("hidden").attr(FSG_HIDDEN_ATTR,!0)}));[`[${FSG_SELECTED_ATTR}]`,`[${FSG_INSPECTING_ATTR}]`,`[${FSG_DRAGGING_ATTR}]`,`[${FSG_HOVER_ATTR}]`].forEach((t=>{e.find(t).forEach((e=>{e.attr(FSG_SELECTED_ATTR,null).attr(FSG_INSPECTING_ATTR,null).attr(FSG_DRAGGING_ATTR,null).attr(FSG_HOVER_ATTR,null)}))}))}function patchStyles(e){const t=e.defs();t.find("style").forEach((e=>e.remove())),t.first().before(SVG(RUNTIME_DEFAULT_STYLE));t.find("link").forEach((e=>e.remove())),t.first().after(SVG(KATEX_STYLE_LINK)),t.first().after(SVG(RUNTIME_STYLE_LINK))}function patchForeignObjectLaTeX(e){e.find("div.latex-container").forEach((e=>{e.attr("xmlns",null).attr("xmlns","http://www.w3.org/1999/xhtml")}))}function patchToNewClass(e){e.findOne(".ui-select-box")?.attr("class",CLASS_FSG_UI_SELECT_BOX)}function patchToNewAttributes(e){e.find("[component_no]").each((e=>{const t=e.attr("component_no");e.attr("component_no",null).attr(NO_ATTR,t)})),e.find("[component_refs]").each((e=>{const t=e.attr("component_refs");e.attr("component_refs",null).attr(REFS_ATTR,t)})),e.find("[of]").each((e=>{const t=e.attr("of");e.attr("of",null).attr(OF_ATTR,t)})),e.find("[fsg_fill_none]").each((e=>{e.attr("fsg_fill_none",null).attr("fill","none")})),e.find("[label]").each((e=>{const t=e.attr("label");e.attr("label",null).attr(TEXT_ATTR,t)}));["dashed","dashed2","dashed3","dashed4"].forEach((t=>{e.find("."+t).each((e=>{e.removeClass(t).attr(FSG_STROKE_TYPE_ATTR,"dashed")}))}))}function svgDocument(e,t={}){let n=e.parent().svg();const o=SVG(n).attr("xmlns:svgjs",null).attr("xmlns:svgjs","https://svgjs.com/svgjs").attr("xmlns:fsg",null).attr("xmlns:fsg",FSG_NAMESPACE).attr("style",null);for(const[e,n]of Object.entries(t))o.attr(e,n);patchSVGJS(o),cleanupDirtyElements(o),patchStyles(o),patchForeignObjectLaTeX(o),patchToNewClass(o),patchToNewAttributes(o);return o.svg().replace(/\&nbsp;/g,"&#160;")}function htmlForPlayer(e){const t=null!=window.location.origin.match(/^https:\/\/localhost/),n=t?window.location.origin:window.location.href,o=t?`${n}/lib/svg.min.js`:"https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js",r=`${n}/runtime.min.js`,i=svgDocument(e),s=SVG(i);findScript(s.first(),FSG_RUNTIME_NAMESPACE).attr("href",r);findScript(s.first(),SVGJS_SCRIPT_NAMESPACE).attr("href",o);const a=findUserScript(s.first()),c=a.node.textContent;a.node.textContent=`__autoPlay__ = \`${c}\``,s.defs().find("link").forEach((e=>e.remove()));const l=s.svg();return"<!DOCTYPE html>"+String.raw`<head>
    <link rel="icon" href="${n}/images/favicon.ico" type="image/x-icon" />
  </head>
`+'<body><div style="overflow:hidden">'+l+"</div></body></html>"}function saveAsSVG(e){var t=document.createElement("a");const n=svgDocument(e);return t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n)),t.setAttribute("download",e.fsg.filename),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),n}function exportToHTML(e){const t=e.fsg.filename.replace(/\.svg/,".html");var n=document.createElement("a");const o=svgDocument(e,{style:"width:100%;"}),r="<!DOCTYPE html>"+String.raw`<head>
    <title>Fast SVG Geometry</title>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="${SERVER_ROOT}/style/runtime.css">
    <link rel="icon" href="${SERVER_ROOT}/images/favicon.ico" type="image/x-icon" />
  </head>
`+'<body><div style="overflow:hidden">'+o+"</div></body></html>";n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(r)),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function init_module_player(){const e=SVG("#playerWindow"),t=SVG("#playerViewbox");SVG("#playerCloseButton").on("click",(()=>{t.node.innerHTML="",e.addClass("hidden")}))}function playInBuilder(e){const{width:t,height:n}=e.parent().viewbox(),o=document.createElement("iframe");o.width=t+8,o.height=n+20,o.setAttribute("autoplay",!0),o.srcdoc=htmlForPlayer(e);SVG("#playerViewbox").node.appendChild(o),SVG("#playerWindow").removeClass("hidden")}let speechLang="en",allVoices=[],_storyboard,isUtterEnd=!0,isActionEnd=!0;function init_module_animatic(){window.animatic=animatic}function animatic(e){_storyboard=e,actionStart()}function actionStart(){if(!isUtterEnd||!isActionEnd)return;const e=_storyboard.shift();if(!e)return;const[t,n]=e;isActionEnd=!1,isUtterEnd=!1;n((e=>{isActionEnd=!0,e&&actionStart()}));speak(t,(()=>{isUtterEnd=!0,actionStart()}))}function speak(e,t){if(0==allVoices.length)return void wait(300).then((()=>speak(e,t)));const n=voicesBy(speechLang);if(0==n.length)return;queueSpeech(n[0].index,e,t)}function initAllVoices(){speechSynthesis.cancel(),allVoices=speechSynthesis.getVoices()}function voicesBy(e){let t=[];for(const[n,o]of allVoices.entries())o.lang==e&&t.push({voice:o,index:n});return t}function queueSpeech(e,t,n){let o=new SpeechSynthesisUtterance(t);o.voice=allVoices[e],o.onend=n,speechSynthesis.speak(o)}function init_module_history(e){const t={history:[],redo_list:[],doAction:doAction,changeLocation:changeLocation};e.fsg.history=t}function undo(e){const t=e.fsg.history;let n=t.history.pop();n&&(n.undo(),t.redo_list.push(n))}function redo(e){let t=e.fsg.history.redo_list.pop();t&&t.redo()}function doAction(e,t){const{draw:n}=t,o=n.fsg.history,r=e(t);r.redo=()=>{r.no&&(t.no=r.no),doAction(e,t)},o.history.push(r)}speechSynthesis.onvoiceschanged=initAllVoices,initAllVoices();class ChangeLocationAction{constructor(e,t,n,o){for(let n=0;n<t.length;n++){const r=componentByNo(e,t[n]),i=o[n];r.setAttribute("cx",i.x),r.setAttribute("cy",i.y),r.element.fire("update")}this.draw=e,this.refs=t,this.oldValues=n,this.newValues=o}undo(){const e=this.refs,t=this.oldValues;for(let n=0;n<e.length;n++){const o=componentByNo(this.draw,e[n]),r=t[n];o.setAttribute("cx",r.x),o.setAttribute("cy",r.y),o.element.fire("update")}}}function changeLocation({draw:e,refs:t,oldValues:n,newValues:o}){return new ChangeLocationAction(e,t,n,o)}class InvisiblePoint extends Component{constructor({draw:e,element:t,refs:n}){super({draw:e,element:t,refs:n})}select(){}unselect(){}getAttributes(){return[]}}function init_module_selection(e){e.fsg.selection={},e.fsg.selection.selections=[],window.selectComponent=selectComponent$1,window.unselectComponent=unselectComponent$1,window.getSelectedPointElements=getSelectedPointElements$1}const inspector=SVG("#inspector");function inspect(e){inspector?.fire("inspect-component",{component:e})}function detach(){inspector?.fire("inspect-detach")}function selectComponent$1(e,t){if(!e.ready)return;let n=e.fsg.selection.selections;return(Array.isArray(t)?t:[t]).forEach((e=>{e instanceof InvisiblePoint||(e.select(),n=n.filter((t=>t!==e)),n.push(e),inspect(e))})),e.fsg.selection.selections=n,t}function unselectComponent$1(e,t){let n=e.fsg.selection.selections;(Array.isArray(t)?t:[t]).forEach((e=>{e.unselect(),n=n.filter((t=>t!==e))}));const o=n.length;return 0==o?detach():inspect(n[o-1]),e.fsg.selection.selections=n,t}class SelectAllAction{constructor(e){this.draw=e;const t=e.find(`[${NO_ATTR}]`);let n=[];t.forEach((e=>{const t=e.component;t instanceof SelectableComponent&&(t.select(),n.push(t))})),e.fsg.selection.selections=n;const o=n.pop();o&&selectComponent$1(e,o),this.components=n}undo(){unselectComponent$1(this.draw,this.components)}}function selectAllSelectableComponents({draw:e}){return new SelectAllAction(e)}class UnSelectAllAction{constructor(e,t){this.components=t,this.draw=e,unselectComponent$1(e,t)}undo(){selectComponent$1(this.draw,this.components)}}function deselectLastSelection({draw:e}){const t=e.fsg.selection.selections,n=t.pop(),o=new UnSelectAllAction(e,[n]);return 0==t.length&&detach(),e.fsg.selection.selections=t,o}function unselectAllSelections({draw:e}){detach();const t=e.fsg.selection.selections,n=new UnSelectAllAction(e,t);return e.fsg.selection.selections=[],n}function numberOfSelections(e){return e.fsg.selection.selections.length}class DeleteAllSelectionsAction{constructor(e){detach(),this.content=e.parent().svg(),this.draw=e,this.selections=[],e.fsg.selection.selections.forEach((e=>{this.selections.push(e.no),e.remove()})),e.fsg.selection.selections=[]}undo(){this.draw.fire("loadSnapshot",{content:this.content,selections:this.selections})}}function removeAllSelections({draw:e}){return new DeleteAllSelectionsAction(e)}class DeleteLastSelectionAction{constructor(e){detach(),this.content=e.parent().svg(),this.draw=e,this.selections=[],e.fsg.selection.selections.forEach((e=>{this.selections.push(e.no)}));e.fsg.selection.selections.pop().remove()}undo(){this.draw.fire("loadSnapshot",{content:this.content,selections:this.selections})}}function removeLastSelection({draw:e}){return new DeleteLastSelectionAction(e)}function getLastSelectedAppendableComponent(e){const t=e.fsg.selection.selections;for(let e=t.length-1;e>=0;e--){const n=t[e];if(n instanceof LineShape)return n;if(n instanceof Circle)return n}return null}function getLastSelectedLineBaseAndPointComponent(e){const t=e.fsg.selection.selections;let n,o;for(let e=t.length-1;e>=0;e--){const r=t[e];if(!o&&r instanceof LineShape&&(o=r),!n&&r instanceof SelectablePoint&&(n=r),o&&n)return[o,n]}return null}function getLast2SelectedIntersectableComponents(e){const t=e.fsg.selection.selections,n=[];for(let e=t.length-1;e>=0;e--){const o=t[e];if((o instanceof LineShape||o instanceof Circle)&&n.push(o),2==n.length)return[n[1],n[0]]}return null}function lastSelectedComponent(e){const t=e.fsg.selection.selections,n=t.length;return n<1?null:t[n-1]}function getLast2SelectedPointElements(e){let t=getSelectedSelectablePointElements(e),n=t.length;return n<2?null:[t[n-2],t[n-1]]}function getSelectedSelectablePointElements(e){const t=e.fsg.selection.selections;let n=[];return t.forEach((e=>{e instanceof SelectablePoint&&n.push(e.element)})),n}function getSelectedPointElements$1(e){const t=e.fsg.selection.selections;let n=[];return t.forEach((e=>{e instanceof Point&&n.push(e.element)})),n}function getSelectedFillableShapes(e){const t=e.fsg.selection.selections;let n=[];return t.forEach((e=>{e instanceof FillableShape&&n.push(e)})),n}function getSelectedShapes(e){const t=e.fsg.selection.selections;let n=[];return t.forEach((e=>{e instanceof Shape&&n.push(e)})),n}function getSelectedComponents(e){const t=e.fsg.selection.selections;let n=[];return t.forEach((e=>{e instanceof SelectableComponent&&n.push(e)})),n}function getLastSelectedAngleComponents(e){const t=e.fsg.selection.selections;let n=[];return t.forEach((e=>{(e instanceof Arc||e instanceof ArrowedArc||e instanceof LengthMarker)&&n.push(e)})),n}var _cmInstance,_window,_draw;function codeEditor(){const e=document.querySelector("#codeEditor");_window=document.querySelector("#codeEditorWindow"),(_cmInstance=CodeMirror.fromTextArea(e,{mode:{name:"javascript"},autoRefresh:!0,autofocus:!0,tabSize:2,indentUnit:2,lineNumbers:!0,placeholder:"Edit code... (F2 to tooggle vim mode)",theme:"tomorrow-night-bright"})).execCommand("selectAll"),_window.addEventListener("keydown",(e=>{switch(e.code){case"F1":toggle_code_editor(),e.preventDefault(),e.stopPropagation();break;case"F2":"vim"==_cmInstance.options.keyMap?CodeMirror.keyMap.vim&&(CodeMirror.keyMap.vim.detach(_cmInstance),_cmInstance.options.keyMap="default"):CodeMirror.keyMap.vim&&(CodeMirror.keyMap.vim.attach(_cmInstance),_cmInstance.options.keyMap="vim");break;case"KeyE":e.ctrlKey&&(SVG("#runButton").node.click(),e.preventDefault(),e.stopPropagation());break;case"KeyR":e.ctrlKey&&(SVG("#reloadButton").node.click(),e.preventDefault(),e.stopPropagation());break;case"KeyS":if(e.metaKey){e.preventDefault(),e.stopPropagation();const t=saveAsSVG(_draw);return void document.dispatchEvent(new CustomEvent("update_document",{detail:t}))}}}))}function toggle_code_editor(){_window.classList.toggle("l4t-hidden"),_window.classList.contains("l4t-hidden")||_cmInstance.focus()}function init_module_code_editor(e,t){_draw=e,_cmInstance?_cmInstance.off("change"):codeEditor(),setCode(t.node.textContent),_cmInstance.on("change",(()=>{t.node.textContent=getCode()})),CodeMirror.keyMap.vim&&(CodeMirror.keyMap.vim.attach(_cmInstance),_cmInstance.options.keyMap="vim")}function getCode(){return _cmInstance.getValue()}function setCode(e){_cmInstance.setValue(e)}function init_ui_axis(e){let t="axis-x";addAxis({draw:e,type:t}),t="axis-y",addAxis({draw:e,type:t})}function buttonClass(e,t){e.on("click",(()=>t()))}function showHint(e){const t=SVG("#hintBox").node,n=SVG("#message").node;return n.innerText=e??n.innerText,t.classList.remove("fadeInOut"),setTimeout((()=>{t.classList.add("fadeInOut")}),100),!0}function opening_animation(e,t){const n=String.raw`Fast\ SVG\ Geometry\ Builder\ 0.1`,o=addLaTeX({draw:e,text:n,unselect:!0}).element;o.attr("style","color: #fff;"),o.center(0,0).attr("opacity",0),o.animate(400).dmove(0,-30).attr("opacity",1).animate(400,400).attr("opacity",0).after((()=>{o.remove(),e.ready=!0,enableColorPicker();const n=e.findOne(".axis-x").component,r=e.findOne(".axis-y").component;selectComponent(e,[n,r]);addPoint({draw:e,coord:{x:0,y:0}}),showHint(),t?.()}))}loadCSS("lib/codemirror/codemirror.min.css"),loadCSS("lib/codemirror/tomorrow-night-bright.min.css"),loadScript("lib/codemirror/codemirror.min.js"),loadScript("lib/codemirror/placeholder.min.js"),loadScript("lib/codemirror/javascript.min.js"),loadScript("lib/codemirror/autorefresh.min.js"),loadScript("lib/codemirror/vim.min.js");let _visible=!1,_copiedStyle;function init_module_preference(e){const t=e.parent(),n=SVG("#field_pref_width");n.node.value=t.attr("width"),n.on("input",(()=>{const t=Number(n.node.value);if("NaN"==typeof t)return;e.parent().attr("width",t)}));const o=SVG("#field_pref_height");o.node.value=t.attr("height"),o.on("input",(()=>{const t=Number(o.node.value);if("NaN"==typeof t)return;e.parent().attr("height",t)}));SVG("#pref_close_button").on("click",(()=>hide()))}function show(e){const t=e.parent();SVG("#field_pref_width").node.value=t.attr("width");SVG("#field_pref_height").node.value=t.attr("height"),SVG("#preferenceWindow").attr("style","visibility: visible;"),_visible=!0}function hide(){SVG("#preferenceWindow").attr("style","visibility: hidden;"),_visible=!1}function toggle_preference_window(e){_visible?hide():show(e)}function copyStyle(e){const t=["fill","stroke",FSG_STROKE_TYPE_ATTR],n=e.getAttributes();return _copiedStyle={},t.forEach((t=>{if(n.includes(t)){let n=e.getAttribute(t);t==FSG_STROKE_TYPE_ATTR&&void 0===n&&(n=null),_copiedStyle[t]=n}})),_copiedStyle}function isStyleCopied(){return _copiedStyle}function pasteStyle({draw:e,refs:t}){if(!_copiedStyle)return;const n=Object.keys(_copiedStyle);t.forEach((t=>{const o=componentByNo(e,t);n.forEach((e=>{o.setAttribute(e,_copiedStyle[e])}))}))}function doToggleAttribute(e,t){const n=!e.attr(t)||null;e.attr(t,n).fire("update")}class ToggleAction{constructor(e,t,n,o){t.forEach((t=>{const r=componentByNo(e,t);o(r.element,n)})),this.state={draw:e,refs:t,targetName:n,action:o}}undo(){const{draw:e,refs:t,targetName:n,action:o}=this.state;t.forEach((t=>{const r=componentByNo(e,t);o(r.element,n)}))}}function toggleAttribute({draw:e,refs:t,attributeName:n}){return new ToggleAction(e,t,n,doToggleAttribute)}class ChangeAttributesAction{constructor(e,t,n,o,r){for(let o=0;o<t.length;o++){const i=componentByNo(e,t[o]);n.forEach((e=>{i.setAttribute(e,r[e])})),i.element.fire("update")}this.state={draw:e,refs:t,attributeNames:n,oldValues:o}}undo(){const{draw:e,refs:t,oldValues:n,attributeNames:o}=this.state;for(let r=0;r<t.length;r++){const i=componentByNo(e,t[r]),s=n[r];o.forEach((e=>{i.setAttribute(e,s[e])})),i.element.fire("update")}}}function changeStyle({draw:e,refs:t,newValue:n}){const o=[],r=Object.keys(n);return t.forEach((t=>{const n=componentByNo(e,t),i=n.element.orgValue;r.forEach((e=>{const t={};t[e]=i?i[e]:n.getAttribute(e),o.push(t)})),n.element.orgValue=null})),new ChangeAttributesAction(e,t,r,o,n)}const fields=["id","class","cx","cy",TEXT_ATTR,"fill","stroke"],non_color_fields=["id","class","cx","cy",TEXT_ATTR],fieldDefaultValue={id:"",class:"",cx:"",cy:"",fill:DEFAULT_FILL_COLOR,stroke:DEFAULT_STROKE_COLOR};let _inspecting_element;fieldDefaultValue[TEXT_ATTR]="";let _isColorFieldFocused=!1,_currentColorField=SVG("#field_fill").node,_lastVisibleFillColor=DEFAULT_FILL_COLOR,_lastVisibleStrokeColor=DEFAULT_STROKE_COLOR,_keydownHandler,_keyupHandler;function lastVisibleFillColor(){return _lastVisibleFillColor}function lastVisibleStrokeColor(){return _lastVisibleStrokeColor}function whichColorField(){return _currentColorField.getAttribute("id").substr(6)}function altColorPicker(e){const t=SVG(e).node;_currentColorField=t,attachColorPicker(t)}function editField(e){SVG(e).node.focus()}function setInspecting(e){return e?.attr(FSG_INSPECTING_ATTR,!0)}function unsetInspecting(e){return e?.attr(FSG_INSPECTING_ATTR,null)}function setSelected(e){return e?.attr(FSG_SELECTED_ATTR,!0)}function unsetSelected(e){return e?.attr(FSG_SELECTED_ATTR,null)}function inspect_component(e){if(null==e)return void inspect_detach();const t=e.element;_inspecting_element&&unsetInspecting(_inspecting_element).off("update dragend",update_fields),_inspecting_element=t,setInspecting(t),t.on("update dragend",update_fields);e.getAttributes().forEach((t=>{if(t==FSG_STROKE_TYPE_ATTR)return;const n=SVG("#field_"+t).node;let o=e.getAttribute(t);void 0===o&&(o=fieldDefaultValue[t]),"fill"!=t&&"stroke"!=t||("fill"==t&&"none"!=o&&(_lastVisibleFillColor=o),"stroke"==t&&"none"!=o&&(_lastVisibleStrokeColor=o),n.style.backgroundColor=o),n.value=o,SVG(n).fire("change")}))}function inspect_detach(){_inspecting_element&&(unsetInspecting(_inspecting_element),_inspecting_element.off("update dragend",update_fields)),non_color_fields.forEach((e=>{SVG("#field_"+e).node.value=fieldDefaultValue[e]})),_inspecting_element=null}function unsetAllSelected(e){const t=getSelectedComponents(e);e.selectedComponents=t.map((e=>(unsetSelected(e.element),e.no)))}function resetToSelected(e){e.selectedComponents?.forEach((t=>{setSelected(componentByNo(e,t).element)})),e.selectedComponents=null}function init_module_inspector(e){init_fields(e),SVG("#inspector").on("inspect-component",(t=>{e.ready&&inspect_component(t.detail.component)})).on("inspect-detach",(()=>{inspect_detach()})),document.addEventListener("colorpicker:change-start",(t=>{if(!_inspecting_element)return;if(e.targetComponents)return;e.selectedComponents||unsetAllSelected(e);const{field:n}=t.detail,o=n.substr(6);e.shiftKey?e.targetComponents=e.selectedComponents:e.targetComponents=[_inspecting_element.component.no],e.targetComponents.forEach((t=>{const n=componentByNo(e,t),r=n.element,i={};i[o]=n.getAttribute(o),r.orgValue=i})),unsetInspecting(_inspecting_element)})),document.addEventListener("colorpicker:change-end",(t=>{if(!_inspecting_element)return;if(!e.targetComponents)return;const{field:n,newColor:o}=t.detail,r={};r[n.substr(6)]=o;const i=e.targetComponents;e.fsg.history.doAction(changeStyle,{draw:e,refs:i,newValue:r}),_isColorFieldFocused||(resetToSelected(e),setInspecting(_inspecting_element)),e.targetComponents=null}))}function checkColor(e){return/^#[a-f|0-9]{3}$/i.test(e)||/^#[a-f|0-9]{6}$/i.test(e)||/^#[a-f|0-9]{8}$/i.test(e)?e.toLowerCase():"none"}function init_fields(e){_inspecting_element?.off("update dragend",update_fields),_inspecting_element=null,fields.forEach((t=>{const n=SVG("#field_"+t);n.on("input",(t=>{const n=t.target.id.substr(6);let o=t.target.value;["fill","stroke"].includes(n)&&(o=checkColor(t.target.value),"none"!=o&&("fill"==n?_lastVisibleFillColor=o:_lastVisibleStrokeColor=o));try{if(e.targetComponents)return void e.targetComponents.forEach((t=>{componentByNo(e,t).setAttribute(n,o)}));_inspecting_element?.component?.setAttribute(n,o)}catch(e){}})).on("keydown",(t=>{"Enter"==t.code&&n.node.blur(),e.shiftKey=t.shiftKey})).on("keyup",(t=>{e.shiftKey=t.shiftKey}))}));const t=SVG("#inspector").find(".field_color");t.on("focus",(t=>{_currentColorField=t.target,attachColorPicker(t.target),unsetAllSelected(e),unsetInspecting(_inspecting_element),_isColorFieldFocused=!0})).on("blur",(()=>{resetToSelected(e),setInspecting(_inspecting_element),_isColorFieldFocused=!1})).on("input",(e=>{e.target.style.backgroundColor=e.target.value})),t.forEach((e=>e.node.style.backgroundColor=e.node.value))}function update_fields(){const e=_inspecting_element.component;e.getAttributes().forEach((t=>{if(t==FSG_STROKE_TYPE_ATTR)return;const n=SVG("#field_"+t).node;let o=e.getAttribute(t);n.value=""===o||void 0===o?null:String(o)}))}function init_appending_point_module(e){e.addAppendingPinPoint=addAppendingPinPoint,e.endAppendingPoint=t=>{if(!e.appendingPoint)return!1;t.preventDefault(),t.stopPropagation();const n=e.appendingPoint.component,o=n instanceof AppendingPinPoint?addPinPoint:addIntersectPoint,r=n.done();return e.fsg.history.doAction(o,r),e.appendingPoint=null,!0},e.cancelAppendingPoint=()=>{const t=e.appendingPoint.component;t instanceof AppendingPinPoint&&t.targetComponent.endAppendMode(e),t.remove()}}class AppendingPinPoint{constructor({draw:e,componentRef:t,element:n}){this.element=n,n.component=this,e.appendingPoint=n,n.on("move",(()=>n.fire("update",{target:this})));const o=componentByNo(e,t);o.element.on("update",this.update.bind(this)),o.element.on("remove",this.remove.bind(this)),this.draw=e,this.targetComponent=o,this.type=o.element.hasClass("circle")?"circle":"line",this.update()}done(){const e=this.draw,t=this.type,n={x:this.element.cx(),y:this.element.cy()},o=[this.targetComponent.no];return this.remove(),this.targetComponent.endAppendMode(),{draw:e,coord:n,type:t,refs:o}}remove(){this.targetComponent.element.off("update",this.update),this.targetComponent.element.off("remove",this.remove),this.element.remove(),this.draw.appendingPoint=null}update(){if("line"==this.type){const e=this.targetComponent,t=projectPointOnLine(this.draw.mousePosition,e.startPoint(),e.direction());this.element.center(t.x,t.y)}else{const e=this.targetComponent.element,t=this.targetComponent.radius;if(0==t)return;const n={x:e.cx(),y:e.cy()},o={x:this.draw.mousePosition.x-n.x,y:this.draw.mousePosition.y-n.y},r=lengthOfVector(o);if(0==r)return;const i=t/r,s={x:n.x+o.x*i,y:n.y+o.y*i};this.element.center(s.x,s.y)}}}function addAppendingPinPoint({draw:e,componentRef:t}){const n=e.circle(POINT_RADIUS).move(e.mousePosition.x-POINT_RADIUS/2,e.mousePosition.y-POINT_RADIUS/2).attr("class","pin-point").attr(FSG_DRAGGING_ATTR,!0);return new AppendingPinPoint({draw:e,componentRef:t,element:n})}class AppendingIntersectPoint{constructor({draw:e,element:t,intersectPoints:n,refs:o,index:r}){this.element=t,t.component=this,e.appendingPoint=t,t.on("move",(()=>t.fire("update",{target:this}))),this.draw=e,this.intersectPoints=n,this.refs=o,this.index=r,this.update()}done(){const e=this.intersectPoints[this.index];return this.remove(),{draw:this.draw,coord:e,index:this.index,refs:this.refs}}remove(){this.element.remove(),this.draw.appendingPoint=null}update(){const e=distanceOfCoords(this.draw.mousePosition,this.intersectPoints[0])<distanceOfCoords(this.draw.mousePosition,this.intersectPoints[1])?0:1,t=this.intersectPoints[e];this.element.center(t.x,t.y),this.index=e}}function addAppendingIntersectPoint({draw:e,intersectPoints:t,refs:n}){const o=distanceOfCoords(e.mousePosition,t[0])<distanceOfCoords(e.mousePosition,t[1])?0:1,r=t[o],i=e.circle(POINT_RADIUS).center(r.x,r.y).attr("class","pin-point");return new AppendingIntersectPoint({draw:e,element:i,intersectPoints:t,refs:n,index:o})}function chooseIntersectPoint(e,t){if(t[0]instanceof LineShape){if(t[1]instanceof LineShape){const[n,o]=t,r=intersect(n.startPoint(),n.direction(),o.startPoint(),o.direction());e.fsg.history.doAction(addIntersectPoint,{draw:e,coord:r,index:0,refs:[n.no,o.no]})}else{const[n,o]=t;addAppendingIntersectPoint({draw:e,intersectPoints:intersectLineAndCircle(n.startPoint(),n.direction(),o.center(),o.radius),refs:[n.no,o.no]})}return}if(t[1]instanceof LineShape){const[n,o]=t;return void addAppendingIntersectPoint({draw:e,intersectPoints:intersectLineAndCircle(o.startPoint(),o.direction(),n.center(),n.radius),refs:[o.no,n.no]})}const[n,o]=t,r=twoCirclesIntersection({a:n.center().x,b:n.center().y,r:n.radius},{a:o.center().x,b:o.center().y,r:o.radius});r&&addAppendingIntersectPoint({draw:e,intersectPoints:r,refs:[n.no,o.no]})}function hasComponent(e){return!(!e&&showHint("Select one component first!"))}function has2Points(e){return!(!e&&showHint("Select 2 points first!"))}function has3Points(e){return!((!e||e.length<3)&&showHint("Select 3 points first!"))}function setStrokeType(e,t,n){const o={};if(o[FSG_STROKE_TYPE_ATTR]=n,e.shiftKey){return void doAction(changeStyle,{draw:t,refs:getSelectedShapes(t).map((e=>e.no)),newValue:o})}const r=lastSelectedComponent(t);if((!r||!(r instanceof Shape))&&showHint("Select a shape first!"))return;if(r.element.attr(FSG_STROKE_TYPE_ATTR)==n)return;doAction(changeStyle,{draw:t,refs:[r.no],newValue:o})}function init_module_keybinding(e){_keyupHandler&&document.removeEventListener("keyup",_keyupHandler),_keydownHandler&&document.removeEventListener("keydown",_keydownHandler),_keyupHandler=t=>{e.shiftKey=t.shiftKey},document.addEventListener("keyup",_keyupHandler);const t=SVG("#playerWindow"),n=SVG("#playerViewbox");_keydownHandler=o=>{if(e.shiftKey=o.shiftKey,void 0!==window.FSG_BUILDER&&o.target!=document.body)return;if(!e.ready)return;if(!t.hasClass("hidden"))return o.preventDefault(),o.stopPropagation(),n.node.innerHTML="",void t.addClass("hidden");if(e.appendingPoint)return void("Escape"==o.code&&e.cancelAppendingPoint());o.metaKey&&o.altKey&&"KeyI"==o.code||o.metaKey&&"KeyR"==o.code||(o.preventDefault(),o.stopPropagation());let r,i=getLast2SelectedPointElements(e);switch(i&&(r=i.map((e=>e.attr(NO_ATTR)))),o.code){case"Enter":playInBuilder(e);break;case"F1":toggle_code_editor();break;case"Comma":o.metaKey&&toggle_preference_window(e);break;case"Tab":{const t=getLastSelectedAngleComponents(e);if(!t&&showHint("Select angle first!"))return;t.forEach((e=>e.toggleMode()))}break;case"Backspace":if(!hasComponent(lastSelectedComponent(e)))return;if(o.shiftKey)return void doAction(removeAllSelections,{draw:e});doAction(removeLastSelection,{draw:e});break;case"BracketLeft":{const t=lastSelectedComponent(e);if(!hasComponent(t))return;o.shiftKey?t.back():t.backward()}break;case"BracketRight":{const t=lastSelectedComponent(e);if(!hasComponent(t))return;o.shiftKey?t.front():t.forward()}break;case"Digit1":setStrokeType(o,e,"dashed");break;case"Digit2":setStrokeType(o,e,"dashed2");break;case"Digit3":setStrokeType(o,e,"dashed3");break;case"Digit4":setStrokeType(o,e,"dashed4");break;case"KeyA":{if(o.metaKey)return void doAction(selectAllSelectableComponents,{draw:e});if(o.shiftKey){if(i=getSelectedSelectablePointElements(e),!has3Points(i))return;return i=[i[0],i[1],i[2]],r=i.map((e=>e.attr(NO_ATTR))),void doAction(addAngle,{draw:e,refs:r})}const t=getLastSelectedAppendableComponent(e);if(t)return void t.toggleAppendMode(e);const n=e.mousePosition;doAction(addPoint,{draw:e,coord:n})}break;case"KeyB":if(i=getSelectedSelectablePointElements(e),!has3Points(i))return;i=[i[0],i[1],i[2]],r=i.map((e=>e.attr(NO_ATTR))),doAction(addBisectorLine,{draw:e,refs:r});break;case"KeyC":if(o.altKey)return void editField("#field_class");if(o.metaKey){const t=svgDocument(e);return void navigator.clipboard.writeText(t).then((()=>showHint("Copied to the clipboard!")))}if(o.ctrlKey){const t=lastSelectedComponent(e);if((!t||!(t instanceof Shape))&&showHint("Select a shape first"))return;return copyStyle(t),void showHint("Copied Style!")}if(!has2Points(i))return;doAction(addCircle,{draw:e,refs:r});break;case"KeyD":numberOfSelections(e)>0&&(o.metaKey?doAction(unselectAllSelections,{draw:e}):doAction(deselectLastSelection,{draw:e}));break;case"KeyE":if(o.metaKey)return void exportToHTML(e);if(o.ctrlKey)return void SVG("#runButton").node.click();if(o.shiftKey){if(i=getSelectedSelectablePointElements(e),(!i||i.length<3)&&showHint("At least 3 points to close the shape"))return;r=i.map((e=>e.attr(NO_ATTR)));const t=r[0];return r=[r[i.length-1],t],void doAction(addEdge,{draw:e,refs:r})}if(!has2Points(i))return;doAction(addEdge,{draw:e,refs:r});break;case"KeyF":{if(o.altKey)return void altColorPicker("#field_fill");const t=whichColorField(),n={};if(n[t]="fill"==t?lastVisibleFillColor():lastVisibleStrokeColor(),o.shiftKey){const t=getSelectedFillableShapes(e);if(!t[0]&&showHint("Select one circle or polygon first!"))return;return r=t.map((e=>e.no)),void doAction(changeStyle,{draw:e,refs:r,newValue:n})}const i=lastSelectedComponent(e);if((!i||!(i instanceof FillableShape))&&showHint("Select one circle or polygon first!"))return;if("none"!=i.getAttribute("fill"))return;r=[i.no],doAction(changeStyle,{draw:e,refs:r,newValue:n})}break;case"KeyH":{if(o.shiftKey){let t=getSelectedComponents(e);if(!hasComponent(t[0]))return;return r=t.map((e=>e.no)),void doAction(toggleAttribute,{draw:e,refs:r,attributeName:FSG_HIDDEN_ATTR})}const t=lastSelectedComponent(e);if(!hasComponent(t))return;r=[t.no],doAction(toggleAttribute,{draw:e,refs:r,attributeName:FSG_HIDDEN_ATTR})}break;case"KeyI":{if(o.metaKey)return;if(o.altKey)return void editField("#field_id");const t=getLast2SelectedIntersectableComponents(e);if(!t)return void showHint("Select 2 intersectable components(line or circle) first");chooseIntersectPoint(e,t)}break;case"KeyL":has2Points(i)&&doAction(addLine,{draw:e,refs:r});break;case"KeyM":if(o.shiftKey){if(i=getSelectedSelectablePointElements(e),!has2Points(i))return;return 2==i.length?(r=i.map((e=>e.attr(NO_ATTR))),void doAction(addLengthMarker,{draw:e,refs:r})):(i=[i[0],i[1],i[2]],r=i.map((e=>e.attr(NO_ATTR))),void doAction(addAngleMarker,{draw:e,refs:r}))}if(!has2Points(i))return;doAction(addMidPoint,{draw:e,refs:r});break;case"KeyN":{const t={};if(t[whichColorField()]="none",o.shiftKey){let n=getSelectedFillableShapes(e);if(!n[0]&&showHint("Select one circle or polygon first!"))return;return r=n.map((e=>e.no)),void doAction(changeStyle,{draw:e,refs:r,newValue:t})}const n=lastSelectedComponent(e);if((!n||!(n instanceof FillableShape))&&showHint("Select one circle or polygon first!"))return;if("none"==n.getAttribute("fill"))return;r=[n.no],doAction(changeStyle,{draw:e,refs:r,newValue:t})}break;case"KeyP":if(i=getSelectedSelectablePointElements(e),!has3Points(i))return;r=i.map((e=>e.attr(NO_ATTR))),doAction(addPolygon,{draw:e,refs:r});break;case"KeyO":if(o.metaKey){const e=SVG("#file");e.node.value="",e.node.click()}break;case"KeyR":if(o.ctrlKey)SVG("#reloadButton").node.click();else if(!o.metaKey){if(!has2Points(i))return;doAction(addRay,{draw:e,refs:r})}break;case"KeyS":{if(o.metaKey){const t=saveAsSVG(e);return void document.dispatchEvent(new CustomEvent("update_document",{detail:t}))}if(o.altKey)return void altColorPicker("#field_stroke");const t={};if(t[FSG_STROKE_TYPE_ATTR]=null,o.shiftKey){const n=getSelectedShapes(e);if(!hasComponent(n[0]))return;return r=n.map((e=>e.no)),void doAction(changeStyle,{draw:e,refs:r,newValue:t})}const n=lastSelectedComponent(e);if((!n||!(n instanceof Shape))&&showHint("Select a shape first!"))return;r=[n.no],doAction(changeStyle,{draw:e,refs:r,newValue:t})}break;case"KeyT":if(o.shiftKey){const t=lastSelectedComponent(e);if(!t)return void showHint("Select the target component first!");const n=[t.no];doAction(addLaTeX,{draw:e,refs:n})}else o.altKey||doAction(addLaTeX,{draw:e});editField("#field_"+TEXT_ATTR);break;case"KeyV":if(o.ctrlKey){if(!isStyleCopied()&&showHint("Copy a style first!"))return;const t=lastSelectedComponent(e);if((!t||!(t instanceof Shape))&&showHint("Can only paste the style to a shape"))return;return void pasteStyle({draw:e,refs:[t.no]})}has2Points(i)&&doAction(addVector,{draw:e,refs:r});break;case"Equal":{const t=getLastSelectedLineBaseAndPointComponent(e);if(!t)return void showHint("Select one line/edge/vector and one point first");const[n,r]=t,i=[n.no,r.no];o.shiftKey?doAction(addPerpLine,{draw:e,refs:i}):doAction(addParallelLine,{draw:e,refs:i})}break;case"KeyX":{const t=getLastSelectedLineBaseAndPointComponent(e);if(!t)return void showHint("Select one line/edge/vector and one point first");const[n,o]=t,r=projectPointOnLine(o.center(),n.startPoint(),n.direction()),i=[n.no,o.no];doAction(addIntersectPoint,{draw:e,coord:r,index:0,refs:i})}break;case"KeyU":case"KeyZ":o.shiftKey?redo(e):undo(e)}},document.addEventListener("keydown",_keydownHandler)}const _serverURL="https://fathomless-brushlands-18222.herokuapp.com";function fetchURL(e,t){return new Promise(((n,o)=>{fetch(e,t).then((e=>e.json())).then((e=>{e.error?o(e.error):n(e)})).catch((e=>{o(e)}))}))}function stdGetHeader(){return{method:"GET",headers:new Headers({"Content-Type":"text/plain"})}}function getHash(){return fetchURL(_serverURL+"/code/hash",stdGetHeader())}function getCode$1(e){return fetchURL(_serverURL+"/code/"+e,stdGetHeader())}function postCode(e,t){return fetchURL(_serverURL+"/code/"+e,{method:"POST",body:JSON.stringify(t),headers:new Headers({"Content-Type":"application/json"})})}const MENU_WIDTH=180,MENU_PADDING_LEFT=10,MENU_PADDING_TOP=5,MENU_PADDING_BOTTOM=5,MENU_ITEM_HEIGHT=23,MENU_BACKGROUND_COLOR="#202020",MENU_BORDER_COLOR="#666",MENU_SEPARATOR_COLOR_TOP="#555",MENU_SEPARATOR_COLOR_BOTTOM="#121212";class MenuItem{constructor(e,t,n){const o=t.text(n).flip("y").attr("class","menu_item");o.on("mousedown",(t=>{this.onMouseDown(e),t.preventDefault(),t.stopPropagation()})),o.menu=t,this.item=o}move(e,t){this.item.move(e,t)}onMouseDown(){}}class Menu{constructor(e,t,n){this.draw=e;const o=e.group().translate(t.x,t.y).attr("class","menu"),r=o.rect(MENU_WIDTH,50).flip("y").stroke({color:MENU_BORDER_COLOR,width:.3}).fill(MENU_BACKGROUND_COLOR);o.text(n).flip("y").attr("class","menu_title").move(MENU_PADDING_LEFT,MENU_PADDING_TOP),this.numItems=0,this.menu=o,this.background=r,e.menu=this}addMenuItem(e,t){const n=new MenuItem(this.draw,this.menu,e);n.onMouseDown=()=>{this.remove(),t()},this.numItems++;const o=MENU_PADDING_TOP+MENU_ITEM_HEIGHT*this.numItems;this.menu.line(MENU_PADDING_LEFT-5,o,MENU_WIDTH+5-MENU_PADDING_LEFT,o).flip("y").stroke(MENU_SEPARATOR_COLOR_TOP),this.menu.line(MENU_PADDING_LEFT-5,o+1,MENU_WIDTH+5-MENU_PADDING_LEFT,o+1).flip("y").stroke(MENU_SEPARATOR_COLOR_BOTTOM),n.move(MENU_PADDING_LEFT,o+3),this.background.size(MENU_WIDTH,o+MENU_ITEM_HEIGHT+MENU_PADDING_BOTTOM)}remove(){this.menu.remove(),this.draw.menu=null}}class RuntimeMenu extends Menu{constructor(e,t){super(e,t,"Menu"),this.addMenuItem("Edit",(()=>{const t=SVG(e.parent().svg());t.findOne("#FSG_UI_LAYER")?.remove(),t.findOne("#FSG_HOVER_FILTER")?.remove();const n={code:t.svg()};getHash().then((e=>{const t=e.hash;postCode(t,n).then((()=>{window.open(SERVER_ROOT+"?source=pwa&hash="+t,"_blank",`resizable, width=${DEFAULT_WINDOW_WIDTH}, height=${DEFAULT_WINDOW_HEIGHT}`)})).catch((e=>{}))})).catch((e=>{}))})),this.addMenuItem("Play",(()=>execute_user_script(e))),this.addMenuItem("Reload",(()=>{const t=e.parent().parent();t&&t.attr("src")?document.dispatchEvent(new CustomEvent("load-fsg",{detail:t})):location.reload()})),e.fsg.filename&&this.addMenuItem(e.fsg.filename,(()=>{}))}}class BuilderMenu extends Menu{constructor(e,t){super(e,t,"Menu"),this.addMenuItem("Open File",(()=>{const e=SVG("#file");e.node.value="",e.node.click()})),this.addMenuItem("Copy As SVG",(()=>{const t=svgDocument(e);navigator.clipboard.writeText(t).then((()=>{showHint("Copied!")}))})),this.addMenuItem("Save As SVG",(()=>saveAsSVG(e))),this.addMenuItem("Export to HTML",(()=>exportToHTML(e))),this.addMenuItem("Reset Viewbox",(()=>{const t=e.parent().attr("width"),n=e.parent().attr("height");e.parent().viewbox(0,0,t,n)})),this.addMenuItem("Preference",(()=>toggle_preference_window(e)))}}function moveElementByOffset(e,t){if(0==t.x&&0==t.y)return;const n={x:e.orgValue.x+t.x,y:e.orgValue.y+t.y};"text"==e.type||e.component instanceof LaTeX?e.center(n.x,-n.y):e.center(n.x,n.y),e.fire("dragmove")}function init_module_drag(e){let t;e.on("contextmenu",(e=>e.preventDefault()));const n=e.findOne("."+CLASS_FSG_UI_SELECT_BOX);n?t=n:(t=e.parent().rect(0,0).attr("class",CLASS_FSG_UI_SELECT_BOX),e.add(t)),e.selectBox=t,e.selectStart=null,e.dragTarget=null,e.on("mousedown",(t=>{e.menu?e.menu.remove():isRightButton(t)?window.FSG_RUNTIME?new RuntimeMenu(e,e.point(t.clientX,t.clientY)):window.FSG_BUILDER&&new BuilderMenu(e,e.point(t.clientX,t.clientY)):0==t.button&&(window.FSG_BUILDER&&e.endAppendingPoint(t)||(t.altKey||(e.selectStart=e.point(t.clientX,t.clientY)),e.lastEvent="mousedown",e.dragTarget=null))})).on("mouseup_on_document",(()=>{e.dragTarget&&(e.dragTarget.fire("dragend"),e.dragTarget=null),e.selectStart&&(e.selectStart=null,t.size(0,0))})).on("mouseup",(n=>{if(!isRightButton(n)&&(e.dragTarget&&(e.dragTarget.fire("dragend"),e.dragTarget=null),e.selectStart=null,t.size(0,0),"mousedown"==e.lastEvent&&(e.lastEvent="mouseup",window.FSG_BUILDER))){let t=e.point(n.clientX,n.clientY);t=snapTo(t),e.fsg.history.doAction(addPoint,{draw:e,coord:t})}})).on("mousemove",(n=>{e.lastEvent="mousemove";const o=snapTo(e.point(n.clientX,n.clientY));if(e.mousePosition=o,e.appendingPoint)return void e.appendingPoint.component.update();const r=e.dragTarget;if(r){const t=r.component;if(t instanceof PinPoint)return void t.update();const n={x:o.x-e.dragStart.x,y:o.y-e.dragStart.y};if(e.dragPoints){return void e.dragPoints.forEach((e=>{moveElementByOffset(e,n)}))}moveElementByOffset(r,n)}else if(e.selectStart){let r=Math.abs(o.x-e.selectStart.x),i=Math.abs(o.y-e.selectStart.y),s=(o.x+e.selectStart.x)/2,a=(o.y+e.selectStart.y)/2;t.size(r,i).center(s,a),selectAllInBox(e,t,n.shiftKey)}}))}function selectAllInBox(e,t,n){e.find(`[${NO_ATTR}]`).forEach((o=>{if(o.component instanceof InvisiblePoint)return;if(!n&&o.attr(FSG_SELECTED_ATTR))return;const r=o.bbox();t.inside(r.x,r.y)&&t.inside(r.x+r.width,r.y+r.height)&&(n?unselectComponent(e,o.component):selectComponent(e,o.component))}))}function init_module_marker(e){deinit_module_marker(e),e.fsg.marker={};let t=e.parent().defs().findOne(".vector-start-marker");t||(t=e.parent().marker(2*VECTOR_START_MARKER_RADIUS,2*VECTOR_START_MARKER_RADIUS,(e=>{const t=VECTOR_START_MARKER_RADIUS;e.circle(t).radius(t).cx(t).cy(t).attr("class","vector-marker-start")})),t.attr("class","vector-start-marker")),e.fsg.marker.vector_start_marker=t;let n=e.parent().defs().findOne(".vector-end-marker");n||(n=e.parent().marker(VECTOR_END_MARKER_ARROW_LENGTH,VECTOR_END_MARKER_ARROW_WIDTH,(e=>{const t=String.raw`0 0, ${VECTOR_END_MARKER_ARROW_LENGTH} ${VECTOR_END_MARKER_ARROW_WIDTH/2}, 0 ${VECTOR_END_MARKER_ARROW_WIDTH}`;e.polygon(t).stroke({width:1}).attr("class","vector-marker-end")})),n.size(VECTOR_END_MARKER_ARROW_LENGTH,VECTOR_END_MARKER_ARROW_WIDTH),n.ref(VECTOR_END_MARKER_ARROW_LENGTH,VECTOR_END_MARKER_ARROW_WIDTH/2),n.attr("class","vector-end-marker")),e.fsg.marker.vector_end_marker=n}function deinit_module_marker(e){e.fsg.marker?.vector_start_marker&&(e.fsg.marker.vector_start_marker.remove(),e.fsg.marker.vector_start_marker=null),e.fsg.marker?.vector_end_marker&&(e.fsg.marker.vector_end_marker.remove(),e.fsg.marker.vector_end_marker=null)}const{Svg:Svg,on:on,off:off,extend:extend,Matrix:Matrix,Box:Box}=SVG,normalizeEvent=e=>e.touches||[{clientX:e.clientX,clientY:e.clientY}];extend(Svg,{panZoom(e){if(this.off(".panZoom"),!1===e)return this;const t=(e=e??{}).zoomFactor??2,n=e.zoomMin??Number.MIN_VALUE,o=e.zoomMax??Number.MAX_VALUE,r=e.wheelZoom??!0,i=e.pinchZoom??!0,s=e.panning??!0,a=e.panButton??0,c=e.oneFingerPan??!1,l=e.margins??!1,d=e.wheelZoomDeltaModeLinePixels??17,u=e.wheelZoomDeltaModeScreenPixels??53;let p,f,h=!1;const m=e=>{if(!l)return e;const{top:t,left:n,bottom:o,right:r}=l,i=this.width()/e.width,{width:s,height:a}=this.attr(["width","height"]),c=s-n/i,d=(r-s)/i,u=a-t/i,p=(o-a)/i;return e.x=Math.min(c,Math.max(d,e.x)),e.y=Math.min(u,Math.max(p,e.y)),e},_=function(e){if(!e.altKey)return;let r;switch(e.preventDefault(),e.deltaMode){case 1:r=e.deltaY*d;break;case 2:r=e.deltaY*u;break;default:r=e.deltaY}let i=Math.pow(1+t,-1*r/100)*this.zoom();const s=this.point(e.clientX,e.clientY);if(i>o&&(i=o),i<n&&(i=n),this.dispatch("zoom",{level:i,focus:s}).defaultPrevented)return this;if(this.zoom(i,s),l){const e=m(this.viewbox());this.viewbox(e)}},g=function(e){e.altKey&&(f=normalizeEvent(e),f.length<2?s&&c&&S.call(this,e):(s&&c&&x.call(this,e),e.preventDefault(),this.dispatch("pinchZoomStart",{event:e}).defaultPrevented||(this.off("touchstart.panZoom",g),h=!0,on(document,"touchmove.panZoom",T,this,{passive:!1}),on(document,"touchend.panZoom",y,this,{passive:!1}))))},y=function(e){if(!e.altKey)return;e.preventDefault();const t=normalizeEvent(e);t.length>1||(h=!1,this.dispatch("pinchZoomEnd",{event:e}),off(document,"touchmove.panZoom",T),off(document,"touchend.panZoom",y),this.on("touchstart.panZoom",g),t.length&&s&&c&&S.call(this,e))},T=function(e){if(!e.altKey)return;e.preventDefault();const t=normalizeEvent(e),r=this.zoom();let i=Math.sqrt(Math.pow(f[0].clientX-f[1].clientX,2)+Math.pow(f[0].clientY-f[1].clientY,2))/Math.sqrt(Math.pow(t[0].clientX-t[1].clientX,2)+Math.pow(t[0].clientY-t[1].clientY,2));(r<n&&i>1||r>o&&i<1)&&(i=1);const s={x:t[0].clientX+.5*(t[1].clientX-t[0].clientX),y:t[0].clientY+.5*(t[1].clientY-t[0].clientY)},a=f[0].clientX+.5*(f[1].clientX-f[0].clientX),c=f[0].clientY+.5*(f[1].clientY-f[0].clientY),l=this.point(s.x,s.y),d=this.point(2*s.x-a,2*s.y-c),u=new Box(this.viewbox()).transform((new Matrix).translate(-d.x,-d.y).scale(i,0,0).translate(l.x,l.y));m(u),this.viewbox(u),f=t,this.dispatch("zoom",{box:u,focus:d})},S=function(e){if(!e.altKey)return;e.type.indexOf("mouse")>-1&&e.button!==a&&e.which!==a+1||(e.preventDefault(),this.off("mousedown.panZoom",S),f=normalizeEvent(e),h||(this.dispatch("panStart",{event:e}),p={x:f[0].clientX,y:f[0].clientY},on(document,"touchmove.panZoom mousemove.panZoom",w,this,{passive:!1}),on(document,"touchend.panZoom mouseup.panZoom",x,this,{passive:!1})))},x=function(e){e.preventDefault(),off(document,"touchmove.panZoom mousemove.panZoom",w),off(document,"touchend.panZoom mouseup.panZoom",x),this.on("mousedown.panZoom",S),this.dispatch("panEnd",{event:e})},w=function(e){e.preventDefault();const t=normalizeEvent(e),n={x:t[0].clientX,y:t[0].clientY},o=this.point(n.x,n.y),r=this.point(p.x,p.y),i=[r.x-o.x,r.y-o.y];if(!i[0]&&!i[1])return;const s=new Box(this.viewbox()).transform((new Matrix).translate(i[0],i[1]));p=n,m(s),this.dispatch("panning",{box:s,event:e}).defaultPrevented||this.viewbox(s)};return r&&this.on("wheel.panZoom",_,this,{passive:!1}),i&&this.on("touchstart.panZoom",g,this,{passive:!1}),s&&this.on("mousedown.panZoom",S,this,{passive:!1}),this}});let _draw$1=null,_document=null,_windowSize={};function openFile(e){if(!e)return;const t=new FileReader;t.addEventListener("load",(function(){_draw$1=loadFSG(t.result),_draw$1&&(_draw$1.fsg.filename=e.name)}),!1),t.readAsText(e)}function resized(e){const t=document.body.clientWidth,n={x:0,y:0,width:t,height:.75*t};e.parent().size(n.width,n.height).viewbox(n);const o=e.transform();e.translate(n.width/2-o.translateX,n.height/2-o.translateY),e.findOne(".fsg-board")?.size(n.width,n.height).center(0,0);let r={x:-n.width/2,y:0},i={x:n.width/2,y:0};e.findOne(".axis-x")?.component.setCoord(r,i),r={x:0,y:-n.height/2},i={x:0,y:n.height/2},e.findOne(".axis-y")?.component.setCoord(r,i)}function cleanUp(){_draw$1&&deinit_component_system(_draw$1),SVG("#editArea").clear(),_draw$1=null,_document=null}function setSnapshotHandler(e){e.on("loadSnapshot",(e=>{_draw$1=loadFSG(e.detail.content),_draw$1.ready=!0,e.detail.selections.forEach((e=>{selectComponent(_draw$1,componentByNo(_draw$1,e))}))}))}function newFSG(){cleanUp();const e=SVG(),t=document.body.clientWidth,n={width:t,height:.75*t};e.addTo("#editArea").size(n.width,n.height).viewbox(0,0,n.width,n.height).panZoom({zoomMin:1,zoomMax:3});const o=e.group().flip("y").translate(n.width/2,n.height/2);o.fsg={},o.fsg.filename="fsg.svg",init_module_marker(o),o.defs().add(SVG(RUNTIME_DEFAULT_STYLE)),o.defs().add(SVG(RUNTIME_STYLE_LINK)),o.defs().add(SVG(KATEX_STYLE_LINK)),init_module_script(o),o.rect(n.width,n.height).attr("class",CLASS_FSG_BOARD).attr("fill",DEFAULT_TRANSPARENT_COLOR).radius(DEFAULT_BOARD_RADIUS).move(-n.width/2,-n.height/2),init_module_history(o),init_module_selection(o),init_component_system(o),init_appending_point_module(o),init_module_drag(o),init_module_inspector(o),init_module_keybinding(o),init_ui_axis(o);return init_module_code_editor(o,findUserScript(o)),init_module_preference(o),setSnapshotHandler(o),o}function loadAsSVG(e){let t;try{t=SVG(e)}catch(e){return alert(e),null}return t&&"svg"===t.type?t:(alert("not correct svg file"),null)}function loadFSG(e){const t=loadAsSVG(e);if(!t)return;cleanUp(),_document=e,t.addTo("#editArea").panZoom({zoomMin:1,zoomMax:3});const n=t.first();n.fsg={},n.fsg.filename="fsg.svg",init_module_marker(n);const o=n.defs();0==o.find("style").length&&o.first().before(SVG(RUNTIME_DEFAULT_STYLE)),init_module_script(n),init_module_history(n),init_module_selection(n),init_component_system(n),init_appending_point_module(n),init_module_drag(n),init_module_keybinding(n),reconstruct_components(n),n.ready=!0,enableColorPicker();init_module_code_editor(n,findUserScript(n)),init_module_preference(n),setSnapshotHandler(n);const r=n.parent().attr("width")+(window.innerWidth-document.body.clientWidth);return window.resizeTo(r,window.outerHeight),_windowSize={width:r,height:window.outerHeight},n}function init(){if("undefined"==typeof CodeMirror)return void wait(300).then((()=>init()));window.FSG_BUILDER=!0,window.resizeTo(DEFAULT_WINDOW_WIDTH,DEFAULT_WINDOW_HEIGHT),init_module_extension(),init_module_color_picker(),init_module_player(),init_module_animatic(),_draw$1=newFSG(),SVG("#file").on("input",(e=>{openFile(e.target.files[0]),e.preventDefault(),e.stopPropagation()})),buttonClass(SVG("#runButton"),(()=>execute_user_script(_draw$1))),buttonClass(SVG("#reloadButton"),(()=>{_document&&(_draw$1=loadFSG(_document))})),_draw$1.mousePosition={x:-150,y:30};const e=()=>{_draw$1&&(_draw$1.mousePosition={x:0,y:0})};window.addEventListener("focus",e),window.addEventListener("blur",e),window.addEventListener("resize",(()=>{window.outerWidth==_windowSize.width&&window.outerHeight==_windowSize.height||(_windowSize={width:window.outerWidth,height:window.outerHeight},resized(_draw$1))})),document.addEventListener("mouseup",(()=>_draw$1?.fire("mouseup_on_document"))),document.addEventListener("update_document",(e=>_document=e.detail)),opening_animation(_draw$1,(()=>{_windowSize={width:window.outerWidth,height:window.outerHeight};const e=new URLSearchParams(window.location.search);if(e.has("hash")){getCode$1(e.get("hash")).then((e=>{_draw$1=loadFSG(e.code)})).catch((e=>{showHint(e.message)}))}}))}return SVG.on(document,"DOMContentLoaded",(()=>init())),exports.loadFSG=loadFSG,Object.defineProperty(exports,"__esModule",{value:!0}),exports}({});